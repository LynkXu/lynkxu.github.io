---
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';
import Base from '../../layouts/Base.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { SITE_DESCRIPTION } from '../../consts';

const posts = (await getCollection('blog'))
	.filter((post) => !post.data.draft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// 按年份分组文章
const postsByYear: Record<number, typeof posts> = {};
posts.forEach((post) => {
	const year = post.data.pubDate.getFullYear();
	if (!postsByYear[year]) {
		postsByYear[year] = [];
	}
	postsByYear[year].push(post);
});

// 获取所有年份并按降序排序
const years = Object.keys(postsByYear)
	.map(Number)
	.sort((a, b) => b - a);
---

<Base title='文章' description={SITE_DESCRIPTION}>
	<p></p>
	<h2>–</h2>
	<div class='posts-archive'>
		{
			years.map((year) => (
				<div class='year-group'>
					<h3 class='year-title'>{year}</h3>
					<ul class='posts'>
						{postsByYear[year].map((post) => (
							<li>
								<span>
									<FormattedDate date={post.data.pubDate} />
								</span>
								<div class="post-item-content">
									{post.data.heroImage ? (
										<div class="post-thumbnail">
											<a href={`/blog/${post.id}.html`}>
												<Image src={post.data.heroImage} alt={post.data.title} />
											</a>
										</div>
									) : (
										<div class="post-thumbnail placeholder">
											<a href={`/blog/${post.id}.html`}>
												<img src="/placeholder-blog.svg" alt="默认封面" />
											</a>
										</div>
									)}
									<a href={`/blog/${post.id}.html`} transition:name={`post-title-${post.id}`}>
										{post.data.title}
									</a>
								</div>
							</li>
						))}
					</ul>
				</div>
			))
		}
	</div>

	<style>
		.post-item-content {
			display: flex;
			align-items: center;
			gap: 15px;
		}
		.post-thumbnail {
			width: 60px;
			height: 40px;
			flex-shrink: 0;
			overflow: hidden;
			border-radius: 6px;
			background-color: #f8f8f8;
			border: 1px solid #eee;
		}
		
		.post-thumbnail img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}
	</style>
</Base>
