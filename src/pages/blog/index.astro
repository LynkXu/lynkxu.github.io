---
import { getCollection } from 'astro:content';
import Base from '../../layouts/Base.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { SITE_DESCRIPTION } from '../../consts';
import { INCLUDE_DRAFTS, filterDrafts } from '../../utils/drafts';

// 排除英文文章（en/ 前缀），英文文章只在 /en/blog 下展示
const posts = filterDrafts(await getCollection('blog'))
	.filter((post) => !post.id.startsWith('en/'))
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// 按年份分组文章
const postsByYear: Record<number, typeof posts> = {};
posts.forEach((post) => {
	const year = post.data.pubDate.getFullYear();
	if (!postsByYear[year]) {
		postsByYear[year] = [];
	}
	postsByYear[year].push(post);
});

// 获取所有年份并按降序排序
const years = Object.keys(postsByYear)
	.map(Number)
	.sort((a, b) => b - a);
---

<Base title='归档' description={SITE_DESCRIPTION}>
	<div class="content-limit-width">
		<p></p>
		<h2>–</h2>
		<div class='posts-archive'>
			{
				years.map((year) => (
					<div class='year-group'>
						<h3 class='year-title'>{year}</h3>
						<ul class='posts'>
							{postsByYear[year].map((post) => (
								<li>
									<span>
										<FormattedDate date={post.data.pubDate} />
									</span>
									<div>
										<a href={`/blog/${post.data.slug ?? post.id}.html`} transition:name={`post-title-${post.id}`}>
											{post.data.title}
										</a>
										{INCLUDE_DRAFTS && post.data.draft && <span class="draft-badge" aria-label="草稿">草稿</span>}
									</div>
								</li>
							))}
						</ul>
					</div>
				))
			}
		</div>
	</div>

	<button class='search-fab' id='search-trigger' type='button' aria-label='搜索文章' title='搜索文章'>
		<svg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2'>
			<circle cx='11' cy='11' r='8'></circle>
			<path d='m21 21-4.35-4.35'></path>
		</svg>
	</button>
</Base>

<script is:inline>
	function initSearchTrigger() {
		var searchTrigger = document.getElementById('search-trigger');
		if (searchTrigger) {
			searchTrigger.addEventListener('click', function () {
				if (window.openSearchModal) {
					window.openSearchModal();
				}
			});
		}
	}

	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initSearchTrigger);
	} else {
		initSearchTrigger();
	}
</script>

<style>
	.search-fab {
		position: fixed;
		right: 18px;
		bottom: 70px;
		z-index: 999;
		width: 42px;
		height: 42px;
		border-radius: 999px;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		color: var(--text-color);
		background: rgba(127, 127, 127, 0.10);
		border: 1px solid rgba(127, 127, 127, 0.25);
		backdrop-filter: blur(8px);
		-webkit-backdrop-filter: blur(8px);
		box-shadow: 0 8px 22px rgba(0, 0, 0, 0.12);
		cursor: pointer;
		transition: all 0.2s ease;
	}

	.search-fab:hover {
		background: rgba(127, 127, 127, 0.16);
		border-color: rgba(127, 127, 127, 0.35);
	}

	.search-fab:focus-visible {
		outline: 2px solid rgba(106, 176, 229, 0.9);
		outline-offset: 3px;
	}

	.search-fab svg {
		display: block;
	}
</style>
