---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import HeaderLink from '../components/HeaderLink.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';

// 导入 index.md 文件
import IndexContent from '../content/index.md';

// 获取最新的博客文章（显示前8篇）
const allPosts = (await getCollection('blog')).filter((post) => !post.data.draft);
const recentPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()).slice(0, 8);

// 统计标签（同 tags 页风格）
const tagsMap = new Map<string, number>();
allPosts.forEach((post) => {
	(post.data.tags || []).forEach((tag) => {
		tagsMap.set(tag, (tagsMap.get(tag) || 0) + 1);
	});
});
const sortedTags = Array.from(tagsMap.entries()).sort((a, b) => b[1] - a[1]);
---

<Base title={SITE_TITLE} description={SITE_DESCRIPTION}>
	<p></p>
	<div class='post-content content'>
		<IndexContent />
	</div>

	<div class='recent-header'>
		<div class='indextitle'>最近文章</div>
		<HeaderLink href='/blog'>查看全部 →</HeaderLink>
	</div>
	<hr class='section-divider' />
	<ul class='posts'>
		{
			recentPosts.map((post) => (
				<li>
					<span>
						<FormattedDate date={post.data.pubDate} />
					</span>
					<div>
						<a href={`/blog/${post.id}.html`} transition:name={`post-title-${post.id}`}>
							{post.data.title}
						</a>
					</div>
				</li>
			))
		}
	</ul>

	{sortedTags.length > 0 && (
		<section class='home-tags'>
			<div class='indextitle'>标签</div>
			<hr class='section-divider' />
			<div class='tags'>
				{sortedTags.map(([tag, count]) => (
					<a href={`/tags/${tag}/`}>
						{tag} ({count})
					</a>
				))}
			</div>
		</section>
	)}

	<style>
		.recent-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.recent-header a {
			font-size: 0.9rem;
		}

		.recent-header .indextitle {
			margin-bottom: 0.3em;
		}

		.home-tags {
			margin: 1.5rem 0 1rem;
		}

		.home-tags .indextitle {
			margin-bottom: 0.3em;
		}

		.section-divider {
			border: none;
			border-top: 2px solid #e5e5e5;
			margin: 0 0 0.8rem 0;
		}
	</style>
</Base>
