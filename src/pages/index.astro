---
import { getCollection } from 'astro:content';
import Base from '../layouts/Base.astro';
import HeaderLink from '../components/HeaderLink.astro';
import FormattedDate from '../components/FormattedDate.astro';
import { SITE_DESCRIPTION, SITE_TITLE } from '../consts';
import { INCLUDE_DRAFTS, filterDrafts } from '../utils/drafts';

// 导入 index.md 文件
import IndexContent from '../content/index.md';

// 获取最新的博客文章（显示前8篇）
// 排除英文文章（en/ 前缀），英文文章只在 /en 下展示
const allPosts = filterDrafts(await getCollection('blog')).filter((post) => !post.id.startsWith('en/'));
const recentPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()).slice(0, 10);

// 统计标签（同 tags 页风格）
const tagsMap = new Map<string, number>();
allPosts.forEach((post) => {
	(post.data.tags || []).forEach((tag) => {
		tagsMap.set(tag, (tagsMap.get(tag) || 0) + 1);
	});
});
const sortedTags = Array.from(tagsMap.entries()).sort((a, b) => b[1] - a[1]);
---

<Base title={SITE_TITLE} description={SITE_DESCRIPTION}>
	<div class="content-limit-width">
		<p></p>
		<div class='post-content content motto'>
			<IndexContent />
		</div>

		<div class='recent-header'>
			<div class='indextitle'>最近文章</div>
		</div>
		<ul class='posts'>
			{
				recentPosts.map((post) => (
					<li>
						<span>
							<FormattedDate date={post.data.pubDate} />
						</span>
						<div>
							<a href={`/blog/${post.data.slug ?? post.id}.html`} transition:name={`post-title-${post.id}`}>
								{post.data.title}
							</a>
							{INCLUDE_DRAFTS && post.data.draft && <span class="draft-badge" aria-label="草稿">草稿</span>}
						</div>
					</li>
				))
			}
		</ul>
		<div class='view-all-container'>
			<HeaderLink href='/blog'>查看全部 →</HeaderLink>
		</div>

		{sortedTags.length > 0 && (
			<section class='home-tags'>
				<div class='indextitle'>标签</div>
				<div class='tags'>
					{sortedTags.map(([tag, count]) => (
						<a href={`/tags/${tag}/`}>
							#{tag} ({count})
						</a>
					))}
				</div>
			</section>
		)}
	</div>

	<style>
		/* 座右铭样式优化 - Minimal Sans */
		.motto {
			font-family: system-ui, -apple-system, sans-serif;
			font-size: 0.95em;
			font-weight: 400;
			color: var(--gray-color);
			opacity: 1;
			margin: 0.5rem 0;
			letter-spacing: 0.05em;
			text-transform: uppercase; /* 全大写，增加一种冷淡的秩序感 */
		}

		.motto :global(p) {
			margin: 0;
		}

		.motto :global(p)::before {
			content: none;
		}

		/* 增加与上方座右铭的距离 */
		.recent-header {
			margin-top: 3rem;
		}

		.recent-header .indextitle {
			margin-bottom: 0.6rem;
		}

		.view-all-container {
			text-align: left;
			margin-top: 1.5rem;
			padding-left: 0;
		}

		.view-all-container a {
			font-size: 0.95em;
			color: var(--gray-color);
			font-weight: 400;
			text-decoration: none;
			border-bottom: 1px solid transparent;
			display: inline-flex;
			align-items: center;
			gap: 4px;
			transition: all 0.2s ease;
		}
		
		.view-all-container a:hover {
			color: var(--heading-color);
			border-bottom-color: var(--heading-color);
		}

		/* 箭头动画 */
		.view-all-container a::after {
			/* content: "→"; 已经在HTML里写了，这里不需要content */
			/* transition: transform 0.2s ease; */
		}
		
		/* 既然HTML里写了箭头是文本的一部分，我们通过HTML结构不好直接控制箭头的transform
		   除非把箭头放到span里。但简单点，我们只做颜色变化即可。
		*/

		.home-tags {
			margin: 0.8rem 0 1rem;
		}

		.home-tags .indextitle {
			margin-bottom: 0.6rem;
		}

		.home-tags .tags a {
			font-size: 0.9rem;
			text-decoration: underline;
			text-underline-offset: 2px;
			/* 防止某些字体把 "(1)" 自动替换成 "①" 等圈号数字 */
			font-variant-ligatures: none;
			font-feature-settings: "liga" 0, "clig" 0, "calt" 0;
		}

		/* 首页“标签”区块：缩小标题与标签列表之间的间距 */
		.home-tags .tags {
			margin-top: 0;
		}

	</style>
</Base>
