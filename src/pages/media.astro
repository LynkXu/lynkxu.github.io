---
import Base from '../layouts/Base.astro';
import SimpleHeader from '../components/SimpleHeader.astro';
import Tabs from '../components/Tabs.astro';
import TabItem from '../components/TabItem.astro';
import MediaCard from '../components/MediaCard.astro';
import neodbData from '../data/neodb.json';

const title = "书影音";
const description = "记录看过的书、电影和玩过的游戏";

    interface NeoDBItem {
        uuid?: string;
        item: {
            title: string;
            cover_image_url: string;
            brief: string;
            rating: number;
            url?: string;
        };
        comment_text: string;
        rating_grade: number;
        created_time: string;
        shelf_type?: string;
    }

// Helper to sort items by creation date (newest first)
const sortItems = (items: NeoDBItem[]) => {
    return items.sort((a, b) => new Date(b.created_time).getTime() - new Date(a.created_time).getTime());
};

const books = sortItems(((neodbData.book || []) as unknown) as NeoDBItem[]);
const movies = sortItems(((neodbData.movie || []) as unknown) as NeoDBItem[]);
const tvs = sortItems(((neodbData.tv || []) as unknown) as NeoDBItem[]); // Add TV shows
const games = sortItems(((neodbData.game || []) as unknown) as NeoDBItem[]);

const splitByStatus = (items: NeoDBItem[]) => {
    const watching = items.filter(item => item.shelf_type === 'progress');
    const completed = items.filter(item => item.shelf_type !== 'progress');
    return { watching, completed };
};

const shouldOpenCompleted = (items: NeoDBItem[]) => items.length <= 8;

const groupByYear = (items: NeoDBItem[]) => {
    const groups = new Map<string, NeoDBItem[]>();
    for (const item of items) {
        const year = Number.isFinite(new Date(item.created_time).getFullYear())
            ? String(new Date(item.created_time).getFullYear())
            : '未知';
        if (!groups.has(year)) {
            groups.set(year, []);
        }
        groups.get(year)?.push(item);
    }
    return Array.from(groups.entries())
        .map(([year, yearItems]) => ({ year, items: yearItems }))
        .sort((a, b) => Number(b.year) - Number(a.year));
};

const bookGroups = splitByStatus(books);
const movieGroups = splitByStatus(movies);
const tvGroups = splitByStatus(tvs);
const gameGroups = splitByStatus(games);

const bookCompletedByYear = groupByYear(bookGroups.completed);
const movieCompletedByYear = groupByYear(movieGroups.completed);
const tvCompletedByYear = groupByYear(tvGroups.completed);
const gameCompletedByYear = groupByYear(gameGroups.completed);
---

<Base title={title} description={description} useCard={false} hideHeader={true} fullWidth={true}>
    <SimpleHeader title="Media" description={description} />

    <div class="content-limit-width media-page">
        <div class="media-tabs">
            <Tabs>
                <TabItem label="书籍" count={books.length}>
                    {books.length > 0 ? (
                        <div class="media-group">
                            <div class="media-group-header">
                                <h3 class="media-group-title">在看</h3>
                            </div>
                            {bookGroups.watching.length > 0 ? (
                                <div class="media-grid">
                                    {bookGroups.watching.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无在看记录。</p>}

                            {bookGroups.completed.length > 0 ? (
                                <details class="media-collapsible" open={shouldOpenCompleted(bookGroups.completed)}>
                                    <summary class="media-group-header">
                                        <h3 class="media-group-title">看过</h3>
                                        <span class="media-group-meta">共 {bookGroups.completed.length} 项</span>
                                    </summary>
                                    <div class="media-pagination" data-page-size="3">
                                        {bookCompletedByYear.map(group => (
                                            <section class="media-year-group" data-year-group>
                                                <div class="media-year-header">
                                                    <h4 class="media-year-title">{group.year}</h4>
                                                    <span class="media-year-meta">共 {group.items.length} 项</span>
                                                </div>
                                                <div class="media-grid">
                                                    {group.items.map(item => (
                                                        <MediaCard
                                                            title={item.item.title}
                                                            cover={item.item.cover_image_url}
                                                            rating={item.rating_grade}
                                                            neodbRating={item.item.rating}
                                                            brief={item.item.brief}
                                                            comment={item.comment_text}
                                                            date={item.created_time}
                                                            link={`https://neodb.social${item.item.url || '#'}`}
                                                            status={item.shelf_type}
                                                        />
                                                    ))}
                                                </div>
                                            </section>
                                        ))}
                                        <div class="media-pager" data-pager>
                                            <button class="media-pager-btn" type="button" data-prev>上一页</button>
                                            <span class="media-pager-info" data-page-info></span>
                                            <button class="media-pager-btn" type="button" data-next>下一页</button>
                                        </div>
                                    </div>
                                </details>
                            ) : <p class="empty-state">暂无看过记录。</p>}
                        </div>
                    ) : <p class="empty-state">暂无书籍记录。</p>}
                </TabItem>

                <TabItem label="电影" count={movies.length}>
                    {movies.length > 0 ? (
                        <div class="media-group">
                            <div class="media-group-header">
                                <h3 class="media-group-title">在看</h3>
                            </div>
                            {movieGroups.watching.length > 0 ? (
                                <div class="media-grid">
                                    {movieGroups.watching.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无在看记录。</p>}

                            {movieGroups.completed.length > 0 ? (
                                <details class="media-collapsible" open={shouldOpenCompleted(movieGroups.completed)}>
                                    <summary class="media-group-header">
                                        <h3 class="media-group-title">看过</h3>
                                        <span class="media-group-meta">共 {movieGroups.completed.length} 项</span>
                                    </summary>
                                    <div class="media-pagination" data-page-size="3">
                                        {movieCompletedByYear.map(group => (
                                            <section class="media-year-group" data-year-group>
                                                <div class="media-year-header">
                                                    <h4 class="media-year-title">{group.year}</h4>
                                                    <span class="media-year-meta">共 {group.items.length} 项</span>
                                                </div>
                                                <div class="media-grid">
                                                    {group.items.map(item => (
                                                        <MediaCard
                                                            title={item.item.title}
                                                            cover={item.item.cover_image_url}
                                                            rating={item.rating_grade}
                                                            neodbRating={item.item.rating}
                                                            brief={item.item.brief}
                                                            comment={item.comment_text}
                                                            date={item.created_time}
                                                            link={`https://neodb.social${item.item.url || '#'}`}
                                                            status={item.shelf_type}
                                                        />
                                                    ))}
                                                </div>
                                            </section>
                                        ))}
                                        <div class="media-pager" data-pager>
                                            <button class="media-pager-btn" type="button" data-prev>上一页</button>
                                            <span class="media-pager-info" data-page-info></span>
                                            <button class="media-pager-btn" type="button" data-next>下一页</button>
                                        </div>
                                    </div>
                                </details>
                            ) : <p class="empty-state">暂无看过记录。</p>}
                        </div>
                    ) : <p class="empty-state">暂无电影记录。</p>}
                </TabItem>

                <TabItem label="剧集" count={tvs.length}>
                    {tvs.length > 0 ? (
                        <div class="media-group">
                            <div class="media-group-header">
                                <h3 class="media-group-title">在看</h3>
                            </div>
                            {tvGroups.watching.length > 0 ? (
                                <div class="media-grid">
                                    {tvGroups.watching.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无在看记录。</p>}

                            {tvGroups.completed.length > 0 ? (
                                <details class="media-collapsible" open={shouldOpenCompleted(tvGroups.completed)}>
                                    <summary class="media-group-header">
                                        <h3 class="media-group-title">看过</h3>
                                        <span class="media-group-meta">共 {tvGroups.completed.length} 项</span>
                                    </summary>
                                    <div class="media-pagination" data-page-size="3">
                                        {tvCompletedByYear.map(group => (
                                            <section class="media-year-group" data-year-group>
                                                <div class="media-year-header">
                                                    <h4 class="media-year-title">{group.year}</h4>
                                                    <span class="media-year-meta">共 {group.items.length} 项</span>
                                                </div>
                                                <div class="media-grid">
                                                    {group.items.map(item => (
                                                        <MediaCard
                                                            title={item.item.title}
                                                            cover={item.item.cover_image_url}
                                                            rating={item.rating_grade}
                                                            neodbRating={item.item.rating}
                                                            brief={item.item.brief}
                                                            comment={item.comment_text}
                                                            date={item.created_time}
                                                            link={`https://neodb.social${item.item.url || '#'}`}
                                                            status={item.shelf_type}
                                                        />
                                                    ))}
                                                </div>
                                            </section>
                                        ))}
                                        <div class="media-pager" data-pager>
                                            <button class="media-pager-btn" type="button" data-prev>上一页</button>
                                            <span class="media-pager-info" data-page-info></span>
                                            <button class="media-pager-btn" type="button" data-next>下一页</button>
                                        </div>
                                    </div>
                                </details>
                            ) : <p class="empty-state">暂无看过记录。</p>}
                        </div>
                    ) : <p class="empty-state">暂无剧集记录。</p>}
                </TabItem>

                <TabItem label="游戏" count={games.length}>
                    {games.length > 0 ? (
                        <div class="media-group">
                            <div class="media-group-header">
                                <h3 class="media-group-title">在玩</h3>
                            </div>
                            {gameGroups.watching.length > 0 ? (
                                <div class="media-grid">
                                    {gameGroups.watching.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无在玩记录。</p>}

                            {gameGroups.completed.length > 0 ? (
                                <details class="media-collapsible" open={shouldOpenCompleted(gameGroups.completed)}>
                                    <summary class="media-group-header">
                                        <h3 class="media-group-title">玩过</h3>
                                        <span class="media-group-meta">共 {gameGroups.completed.length} 项</span>
                                    </summary>
                                    <div class="media-pagination" data-page-size="3">
                                        {gameCompletedByYear.map(group => (
                                            <section class="media-year-group" data-year-group>
                                                <div class="media-year-header">
                                                    <h4 class="media-year-title">{group.year}</h4>
                                                    <span class="media-year-meta">共 {group.items.length} 项</span>
                                                </div>
                                                <div class="media-grid">
                                                    {group.items.map(item => (
                                                        <MediaCard
                                                            title={item.item.title}
                                                            cover={item.item.cover_image_url}
                                                            rating={item.rating_grade}
                                                            neodbRating={item.item.rating}
                                                            brief={item.item.brief}
                                                            comment={item.comment_text}
                                                            date={item.created_time}
                                                            link={`https://neodb.social${item.item.url || '#'}`}
                                                            status={item.shelf_type}
                                                        />
                                                    ))}
                                                </div>
                                            </section>
                                        ))}
                                        <div class="media-pager" data-pager>
                                            <button class="media-pager-btn" type="button" data-prev>上一页</button>
                                            <span class="media-pager-info" data-page-info></span>
                                            <button class="media-pager-btn" type="button" data-next>下一页</button>
                                        </div>
                                    </div>
                                </details>
                            ) : <p class="empty-state">暂无玩过记录。</p>}
                        </div>
                    ) : <p class="empty-state">暂无游戏记录。</p>}
                </TabItem>
            </Tabs>
        </div>
    </div>
</Base>

<script>
    const initMediaPagination = () => {
        document.querySelectorAll<HTMLElement>('.media-pagination').forEach(container => {
            const groups = Array.from(container.querySelectorAll<HTMLElement>('[data-year-group]'));
            const pageSize = Number(container.getAttribute('data-page-size') || 3);
            const pageCount = Math.max(1, Math.ceil(groups.length / pageSize));
            let currentPage = 1;

            const pager = container.querySelector<HTMLElement>('[data-pager]');
            const prevBtn = pager?.querySelector<HTMLButtonElement>('[data-prev]');
            const nextBtn = pager?.querySelector<HTMLButtonElement>('[data-next]');
            const pageInfo = pager?.querySelector<HTMLElement>('[data-page-info]');

            const render = () => {
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = startIndex + pageSize;
                groups.forEach((group, index) => {
                    const isVisible = index >= startIndex && index < endIndex;
                    group.style.display = isVisible ? '' : 'none';
                });

                if (pager) {
                    pager.style.display = pageCount > 1 ? 'flex' : 'none';
                }
                if (prevBtn) {
                    prevBtn.disabled = currentPage <= 1;
                }
                if (nextBtn) {
                    nextBtn.disabled = currentPage >= pageCount;
                }
                if (pageInfo) {
                    pageInfo.textContent = `${currentPage}/${pageCount}`;
                }
            };

            prevBtn?.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage -= 1;
                    render();
                }
            });
            nextBtn?.addEventListener('click', () => {
                if (currentPage < pageCount) {
                    currentPage += 1;
                    render();
                }
            });

            render();
        });
    };

    initMediaPagination();
</script>

<style>
    .media-page {
        padding: 0 0 2rem;
    }

    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
        gap: 1.5rem 0.8rem;
        margin-top: 0.5rem;
    }

    .media-group {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    .media-year-group + .media-year-group {
        margin-top: 1.25rem;
    }

    .media-year-header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }

    .media-year-title {
        margin: 0;
        font-size: 1rem;
        font-weight: 600;
        color: var(--heading-color);
    }

    .media-year-meta {
        font-size: 0.8rem;
        color: var(--gray-color);
        opacity: 0.7;
    }

    .media-pager {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        margin-top: 1.25rem;
    }

    .media-pager-btn {
        border: 1px solid var(--border-color);
        background: var(--card-bg);
        color: inherit;
        padding: 0.35rem 0.75rem;
        border-radius: 999px;
        font-size: 0.85rem;
        cursor: pointer;
    }

    .media-pager-btn:disabled {
        opacity: 0.5;
        cursor: default;
    }

    .media-pager-info {
        font-size: 0.85rem;
        color: var(--gray-color);
    }

    .media-collapsible {
        margin-top: 1.25rem;
    }

    .media-collapsible[open] {
        margin-bottom: 0.5rem;
    }

    .media-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 0 0.35rem 0;
        margin-top: 1.25rem;
        margin-bottom: 0.35rem;
    }

    .media-group-header:first-child {
        margin-top: 0;
    }

    .media-group-title {
        margin: 0;
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--gray-color);
        letter-spacing: 0.03em;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        padding-left: 0.75rem;
    }

    .media-group-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 1em;
        background: var(--heading-color);
        border-radius: 2px;
        opacity: 0.6;
    }

    .media-group-meta {
        font-size: 0.8rem;
        color: var(--gray-color);
        opacity: 0.75;
    }

    .media-collapsible > summary {
        list-style: none;
        cursor: pointer;
    }

    .media-collapsible > summary::-webkit-details-marker {
        display: none;
    }

    .empty-state {
        margin: 0.35rem 0 0;
        color: var(--gray-color);
        font-size: 0.85rem;
        opacity: 0.7;
    }

    .content-limit-width {
        max-width: 1120px;
        margin: 0 auto;
        padding: 0 2rem;
        box-sizing: border-box;
        width: 100%;
    }

    :global(.media-tabs .tabs-header) {
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }

    :global(.media-tabs .tab-btn) {
        font-size: 1rem;
        padding: 0.7rem 0;
    }

    @media (max-width: 600px) {
        .media-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 1.25rem 0.5rem;
        }

    @media (max-width: 450px) {
        .media-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 600px) {
        .content-limit-width {
            padding: 0 1.5rem;
        }
    }
    }
</style>
