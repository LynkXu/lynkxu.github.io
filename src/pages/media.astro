---
import Base from '../layouts/Base.astro';
import SimpleHeader from '../components/SimpleHeader.astro';
import Tabs from '../components/Tabs.astro';
import TabItem from '../components/TabItem.astro';
import MediaCard from '../components/MediaCard.astro';
import neodbData from '../data/neodb.json';

const title = "书影音";
const description = "记录看过的书、电影和玩过的游戏";

    interface NeoDBItem {
        uuid?: string;
        item: {
            title: string;
            cover_image_url: string;
            brief: string;
            rating: number;
            url?: string;
        };
        comment_text: string;
        rating_grade: number;
        created_time: string;
        shelf_type?: string;
        publication_year?: string;
    }

// Helper to sort items by creation date (newest first)
const sortItems = <T extends NeoDBItem>(items: T[]) => {
    return items.sort((a, b) => new Date(b.created_time).getTime() - new Date(a.created_time).getTime());
};

const books = sortItems(((neodbData.book || []) as unknown) as NeoDBItem[]);
const movies = sortItems(((neodbData.movie || []) as unknown) as NeoDBItem[]);
const tvs = sortItems(((neodbData.tv || []) as unknown) as NeoDBItem[]); // Add TV shows
const games = sortItems(((neodbData.game || []) as unknown) as NeoDBItem[]);

const splitByStatus = <T extends NeoDBItem>(items: T[]) => {
    const watching = items.filter(item => item.shelf_type === 'progress');
    const completed = items.filter(item => item.shelf_type !== 'progress');
    return { watching, completed };
};

const shouldOpenCompleted = (items: NeoDBItem[]) => items.length <= 8;

const groupByYear = <T extends NeoDBItem>(items: T[]) => {
    const groups = new Map<string, T[]>();
    for (const item of items) {
        const year = Number.isFinite(new Date(item.created_time).getFullYear())
            ? String(new Date(item.created_time).getFullYear())
            : '未知';
        if (!groups.has(year)) {
            groups.set(year, []);
        }
        groups.get(year)?.push(item);
    }
    return Array.from(groups.entries())
        .map(([year, yearItems]) => ({ year, items: yearItems }))
        .sort((a, b) => Number(b.year) - Number(a.year));
};

const bookGroups = splitByStatus(books);
const tvGroups = splitByStatus(tvs);

const bookCompletedByYear = groupByYear(bookGroups.completed);
const tvCompletedByYear = groupByYear(tvGroups.completed);
const moviesByYear = groupByYear(movies);
const gamesByYear = groupByYear(games);
---

<Base title={title} description={description} useCard={false} hideHeader={true} fullWidth={true}>
    <SimpleHeader title="Media" description={description} />

    <div class="content-limit-width media-page">
        <div class="media-tabs">
            <Tabs>
                <TabItem label="书籍" count={books.length}>
                    {books.length > 0 ? (
                        <div class="media-group">
                            <div class="media-group-header">
                                <h3 class="media-group-title">在看</h3>
                            </div>
                            {bookGroups.watching.length > 0 ? (
                                <div class="media-grid">
                                    {bookGroups.watching.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            year={item.publication_year ?? '未知'}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无在看记录。</p>}

                            {bookGroups.completed.length > 0 ? (
                                <details class="media-collapsible" open={shouldOpenCompleted(bookGroups.completed)}>
                                    <summary class="media-group-header">
                                        <h3 class="media-group-title">看过</h3>
                                        <span class="media-group-meta">共 {bookGroups.completed.length} 项</span>
                                    </summary>
                                    <div class="media-pagination" data-page-size="3">
                                        {bookCompletedByYear.map(group => (
                                            <section class="media-year-group" data-year-group>
                                                <div class="media-year-header">
                                                    <h4 class="media-year-title">{group.year}</h4>
                                                    <span class="media-year-meta">共 {group.items.length} 项</span>
                                                </div>
                                                <div class="media-grid">
                                                    {group.items.map(item => (
                                                        <MediaCard
                                                            title={item.item.title}
                                                            cover={item.item.cover_image_url}
                                                            rating={item.rating_grade}
                                                            neodbRating={item.item.rating}
                                                            brief={item.item.brief}
                                                            comment={item.comment_text}
                                                            date={item.created_time}
                                                            year={item.publication_year ?? '未知'}
                                                            link={`https://neodb.social${item.item.url || '#'}`}
                                                            status={item.shelf_type}
                                                        />
                                                    ))}
                                                </div>
                                            </section>
                                        ))}
                                        <div class="media-pager" data-pager>
                                            <button class="media-pager-btn" type="button" data-prev>上一页</button>
                                            <span class="media-pager-info" data-page-info></span>
                                            <button class="media-pager-btn" type="button" data-next>下一页</button>
                                        </div>
                                    </div>
                                </details>
                            ) : <p class="empty-state">暂无看过记录。</p>}
                        </div>
                    ) : <p class="empty-state">暂无书籍记录。</p>}
                </TabItem>

                <TabItem label="剧集" count={tvs.length}>
                    {tvs.length > 0 ? (
                        <div class="media-group">
                            <div class="media-group-header">
                                <h3 class="media-group-title">在看</h3>
                            </div>
                            {tvGroups.watching.length > 0 ? (
                                <div class="media-grid">
                                    {tvGroups.watching.map(item => (
                                        <MediaCard
                                            title={item.item.title}
                                            cover={item.item.cover_image_url}
                                            rating={item.rating_grade}
                                            neodbRating={item.item.rating}
                                            brief={item.item.brief}
                                            comment={item.comment_text}
                                            date={item.created_time}
                                            year={item.publication_year ?? '未知'}
                                            link={`https://neodb.social${item.item.url || '#'}`}
                                            status={item.shelf_type}
                                        />
                                    ))}
                                </div>
                            ) : <p class="empty-state">暂无在看记录。</p>}

                            {tvGroups.completed.length > 0 ? (
                                <details class="media-collapsible" open={shouldOpenCompleted(tvGroups.completed)}>
                                    <summary class="media-group-header">
                                        <h3 class="media-group-title">看过</h3>
                                        <span class="media-group-meta">共 {tvGroups.completed.length} 项</span>
                                    </summary>
                                    <div class="media-pagination" data-page-size="3">
                                        {tvCompletedByYear.map(group => (
                                            <section class="media-year-group" data-year-group>
                                                <div class="media-year-header">
                                                    <h4 class="media-year-title">{group.year}</h4>
                                                    <span class="media-year-meta">共 {group.items.length} 项</span>
                                                </div>
                                                <div class="media-grid">
                                                    {group.items.map(item => (
                                                        <MediaCard
                                                            title={item.item.title}
                                                            cover={item.item.cover_image_url}
                                                            rating={item.rating_grade}
                                                            neodbRating={item.item.rating}
                                                            brief={item.item.brief}
                                                            comment={item.comment_text}
                                                            date={item.created_time}
                                                            year={item.publication_year ?? '未知'}
                                                            link={`https://neodb.social${item.item.url || '#'}`}
                                                            status={item.shelf_type}
                                                        />
                                                    ))}
                                                </div>
                                            </section>
                                        ))}
                                        <div class="media-pager" data-pager>
                                            <button class="media-pager-btn" type="button" data-prev>上一页</button>
                                            <span class="media-pager-info" data-page-info></span>
                                            <button class="media-pager-btn" type="button" data-next>下一页</button>
                                        </div>
                                    </div>
                                </details>
                            ) : <p class="empty-state">暂无看过记录。</p>}
                        </div>
                    ) : <p class="empty-state">暂无剧集记录。</p>}
                </TabItem>

                <TabItem label="电影" count={movies.length}>
                    {movies.length > 0 ? (
                        <div class="media-group">
                            <div class="media-pagination" data-page-size="3">
                                {moviesByYear.map(group => (
                                    <section class="media-year-group" data-year-group>
                                        <div class="media-year-header">
                                            <h4 class="media-year-title">{group.year}</h4>
                                            <span class="media-year-meta">共 {group.items.length} 项</span>
                                        </div>
                                        <div class="media-grid">
                                            {group.items.map(item => (
                                                <MediaCard
                                                    title={item.item.title}
                                                    cover={item.item.cover_image_url}
                                                    rating={item.rating_grade}
                                                    neodbRating={item.item.rating}
                                                    brief={item.item.brief}
                                                    comment={item.comment_text}
                                                    date={item.created_time}
                                                    year={item.publication_year ?? '未知'}
                                                    link={`https://neodb.social${item.item.url || '#'}`}
                                                    status={item.shelf_type}
                                                />
                                            ))}
                                        </div>
                                    </section>
                                ))}
                                <div class="media-pager" data-pager>
                                    <button class="media-pager-btn" type="button" data-prev>上一页</button>
                                    <span class="media-pager-info" data-page-info></span>
                                    <button class="media-pager-btn" type="button" data-next>下一页</button>
                                </div>
                            </div>
                        </div>
                    ) : <p class="empty-state">暂无电影记录。</p>}
                </TabItem>

                <TabItem label="游戏" count={games.length}>
                    {games.length > 0 ? (
                        <div class="media-group">
                            <div class="media-pagination" data-page-size="3">
                                {gamesByYear.map(group => (
                                    <section class="media-year-group" data-year-group>
                                        <div class="media-year-header">
                                            <h4 class="media-year-title">{group.year}</h4>
                                            <span class="media-year-meta">共 {group.items.length} 项</span>
                                        </div>
                                        <div class="media-grid">
                                            {group.items.map(item => (
                                                <MediaCard
                                                    title={item.item.title}
                                                    cover={item.item.cover_image_url}
                                                    rating={item.rating_grade}
                                                    neodbRating={item.item.rating}
                                                    brief={item.item.brief}
                                                    comment={item.comment_text}
                                                    date={item.created_time}
                                                    year={item.publication_year ?? '未知'}
                                                    link={`https://neodb.social${item.item.url || '#'}`}
                                                    status={item.shelf_type}
                                                />
                                            ))}
                                        </div>
                                    </section>
                                ))}
                                <div class="media-pager" data-pager>
                                    <button class="media-pager-btn" type="button" data-prev>上一页</button>
                                    <span class="media-pager-info" data-page-info></span>
                                    <button class="media-pager-btn" type="button" data-next>下一页</button>
                                </div>
                            </div>
                        </div>
                    ) : <p class="empty-state">暂无游戏记录。</p>}
                </TabItem>
            </Tabs>
        </div>
    </div>
</Base>

<script>
    const initMediaPagination = () => {
        document.querySelectorAll<HTMLElement>('.media-pagination').forEach(container => {
            const groups = Array.from(container.querySelectorAll<HTMLElement>('[data-year-group]'));
            const pageSize = Number(container.getAttribute('data-page-size') || 3);
            const pageCount = Math.max(1, Math.ceil(groups.length / pageSize));
            let currentPage = 1;

            const pager = container.querySelector<HTMLElement>('[data-pager]');
            const prevBtn = pager?.querySelector<HTMLButtonElement>('[data-prev]');
            const nextBtn = pager?.querySelector<HTMLButtonElement>('[data-next]');
            const pageInfo = pager?.querySelector<HTMLElement>('[data-page-info]');

            const render = () => {
                const startIndex = (currentPage - 1) * pageSize;
                const endIndex = startIndex + pageSize;
                groups.forEach((group, index) => {
                    const isVisible = index >= startIndex && index < endIndex;
                    group.style.display = isVisible ? '' : 'none';
                });

                if (pager) {
                    pager.style.display = pageCount > 1 ? 'flex' : 'none';
                }
                if (prevBtn) {
                    prevBtn.disabled = currentPage <= 1;
                }
                if (nextBtn) {
                    nextBtn.disabled = currentPage >= pageCount;
                }
                if (pageInfo) {
                    pageInfo.textContent = `${currentPage}/${pageCount}`;
                }
            };

            prevBtn?.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage -= 1;
                    render();
                }
            });
            nextBtn?.addEventListener('click', () => {
                if (currentPage < pageCount) {
                    currentPage += 1;
                    render();
                }
            });

            render();
        });
    };

    initMediaPagination();
</script>

<style>
    .media-page {
        padding: 0 0 3rem;
        animation: mediaFadeIn 0.5s ease-out;
    }

    @keyframes mediaFadeIn {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ── Grid (small covers) ── */
    .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(105px, 1fr));
        gap: 1.6rem 0.9rem;
        margin-top: 0.6rem;
    }

    .media-group {
        display: flex;
        flex-direction: column;
        gap: 0;
    }

    /* ── Year groups ── */
    .media-year-group + .media-year-group {
        margin-top: 1.6rem;
    }

    .media-year-header {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        margin-bottom: 0.6rem;
    }

    .media-year-title {
        margin: 0;
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--heading-color);
        font-family: var(--serif-font);
        white-space: nowrap;
    }

    .media-year-meta {
        font-size: 0.72rem;
        color: var(--gray-color);
        opacity: 0.55;
        white-space: nowrap;
    }

    .media-year-header::after {
        content: '';
        flex: 1;
        height: 1px;
        background: rgba(0, 0, 0, 0.06);
    }

    :global([data-theme='dark']) .media-year-header::after {
        background: rgba(255, 255, 255, 0.06);
    }

    /* ── Pager ── */
    .media-pager {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1rem;
    }

    .media-pager-btn {
        border: 1px solid rgba(0, 0, 0, 0.1);
        background: transparent;
        color: var(--text-color);
        padding: 0.4rem 1rem;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.15s ease;
        font-family: var(--serif-font);
    }

    .media-pager-btn:hover:not(:disabled) {
        border-color: rgba(0, 0, 0, 0.25);
        background: rgba(0, 0, 0, 0.02);
    }

    :global([data-theme='dark']) .media-pager-btn {
        border-color: rgba(255, 255, 255, 0.1);
    }

    :global([data-theme='dark']) .media-pager-btn:hover:not(:disabled) {
        border-color: rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.03);
    }

    .media-pager-btn:disabled {
        opacity: 0.35;
        cursor: default;
    }

    .media-pager-info {
        font-size: 0.78rem;
        color: var(--gray-color);
        font-variant-numeric: tabular-nums;
        opacity: 0.7;
    }

    /* ── Collapsible ── */
    .media-collapsible {
        margin-top: 1.5rem;
    }

    .media-collapsible[open] {
        margin-bottom: 0.5rem;
    }

    /* ── Group headers ── */
    .media-group-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 0 0.4rem 0;
        margin-top: 1.25rem;
        margin-bottom: 0.4rem;
    }

    .media-group-header:first-child {
        margin-top: 0;
    }

    .media-group-title {
        margin: 0;
        font-size: 0.82rem;
        font-weight: 500;
        color: var(--gray-color);
        letter-spacing: 0.04em;
        text-transform: uppercase;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        position: relative;
        padding-left: 0.75rem;
    }

    .media-group-title::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 3px;
        height: 1em;
        background: var(--heading-color);
        border-radius: 2px;
        opacity: 0.5;
    }

    .media-group-meta {
        font-size: 0.75rem;
        color: var(--gray-color);
        opacity: 0.6;
    }

    .media-collapsible > summary {
        list-style: none;
        cursor: pointer;
        transition: opacity 0.15s;
    }

    .media-collapsible > summary:hover {
        opacity: 0.8;
    }

    .media-collapsible > summary::-webkit-details-marker {
        display: none;
    }

    /* ── Empty state ── */
    .empty-state {
        margin: 1.5rem 0;
        color: var(--gray-color);
        font-size: 0.82rem;
        opacity: 0.5;
        text-align: center;
        font-style: italic;
    }

    /* ── Layout ── */
    .content-limit-width {
        max-width: 1120px;
        margin: 0 auto;
        padding: 0 2rem;
        box-sizing: border-box;
        width: 100%;
    }

    /* ── Tab overrides ── */
    :global(.media-tabs .tabs-header) {
        border-bottom: none;
        margin: 0 0 1.6rem;
        width: 100%;

        display: flex;
        align-items: center;
        justify-content: flex-start;
        gap: 0.65rem;
        padding: 0;

        flex-wrap: wrap;
    }

    :global(.media-tabs .tab-btn) {
        border: none;
        border-bottom: none;
        margin: 0;

        background: rgba(0, 0, 0, 0.02);
        color: var(--text-color);
        padding: 0.52rem 0.95rem;
        border-radius: 12px;

        font-size: 0.95rem;
        font-weight: 650;
        letter-spacing: 0.01em;
        line-height: 1.1;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;

        transition:
            background 0.15s ease,
            border-color 0.15s ease,
            color 0.15s ease,
            box-shadow 0.15s ease,
            transform 0.05s ease;
    }

    :global(.media-tabs .tab-btn:hover:not(.active)) {
        background: rgba(0, 0, 0, 0.04);
    }

    :global(.media-tabs .tab-btn:active) {
        transform: translateY(0.5px);
    }

    :global(.media-tabs .tab-btn.active) {
        background: var(--heading-color);
        color: var(--content-bg);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.12);
    }

    :global(.media-tabs .tab-btn:focus-visible) {
        outline: 2px solid rgba(106, 176, 229, 0.9);
        outline-offset: 2px;
    }

    :global(.media-tabs .tab-count) {
        font-size: 0.78rem;
        font-weight: 650;
        opacity: 0.85;
        padding: 0.06rem 0.48rem;
        border-radius: 999px;
        background: rgba(127, 127, 127, 0.14);
        color: currentColor;
        font-variant-numeric: tabular-nums;
    }

    :global(.media-tabs .tab-btn.active .tab-count) {
        background: rgba(255, 255, 255, 0.18);
        opacity: 0.95;
    }

    :global(.media-tabs .tabs-header::-webkit-scrollbar) {
        display: none;
    }

    :global([data-theme='dark']) .media-tabs .tab-btn {
        background: rgba(255, 255, 255, 0.06);
        color: rgba(255, 255, 255, 0.86);
    }

    :global([data-theme='dark']) .media-tabs .tab-btn:hover:not(.active) {
        background: rgba(255, 255, 255, 0.09);
    }

    :global([data-theme='dark']) .media-tabs .tab-btn.active {
        box-shadow: 0 12px 28px rgba(0, 0, 0, 0.35);
    }

    :global([data-theme='dark']) .media-tabs .tab-count {
        background: rgba(255, 255, 255, 0.12);
    }

    :global([data-theme='dark']) .media-tabs .tab-btn.active .tab-count {
        background: rgba(0, 0, 0, 0.12);
    }

    /* ── Responsive ── */
    @media (max-width: 600px) {
        .media-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 1.3rem 0.5rem;
        }
    }

    @media (max-width: 450px) {
        .media-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 600px) {
        .content-limit-width {
            padding: 0 1.5rem;
        }
    }

    @media (max-width: 600px) {
        :global(.media-tabs .tabs-header) {
            flex-wrap: nowrap;
            justify-content: flex-start;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
            padding: 0.15rem 0;
        }
    }
</style>
