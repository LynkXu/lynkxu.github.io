---
import BaseHead from '../components/BaseHead.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Loading from '../components/Loading.astro';
import SearchModal from '../components/SearchModal.astro';
import Background from '../components/Background.astro';
import type { ImageMetadata } from 'astro';

interface Props {
	title: string;
	description: string;
	image?: ImageMetadata;
    fullWidth?: boolean;
    hideHeader?: boolean;
    hideFooter?: boolean;
    useCard?: boolean; // 新增：是否使用卡片布局
    className?: string; // 新增：传递给卡片的 class
}

const { title, description, image, fullWidth = false, hideHeader = false, hideFooter = false, useCard = true, className = '' } = Astro.props;

// Check if current page is homepage
const isHomepage = Astro.url.pathname === '/';
---

<!doctype html>
<html lang='zh-CN'>
	<head>
		<BaseHead title={title} description={description} image={image} />
		<slot name='head' />
	</head>
	<body class={fullWidth ? 'full-width' : ''}>
		<Background />
		<Loading showOnHomepage={isHomepage} />
        
        {
            useCard ? (
                <div class={`global-layout-card ${className}`}>
                    {!hideHeader && <Header />}
                    <main>
                        <slot />
                    </main>
                    {!hideFooter && <Footer />}
                </div>
            ) : (
                <div class={`global-layout-transparent ${className}`}>
                    {!hideHeader && <Header />}
                    <main>
                        <slot />
                    </main>
                    {!hideFooter && <Footer />}
                </div>
            )
        }
		
		<SearchModal />

		<button
			id="theme-toggle-fab"
			class="theme-toggle-fab"
			type="button"
			aria-label="切换深色模式"
			aria-pressed="false"
		>
			<span class="theme-toggle-icon theme-toggle-icon--moon" aria-hidden="true">
				<svg viewBox="0 0 24 24" width="18" height="18" focusable="false" aria-hidden="true">
					<path d="M21 14.5a8.5 8.5 0 0 1-11.5-11A9 9 0 1 0 21 14.5Z"></path>
				</svg>
			</span>
			<span class="theme-toggle-icon theme-toggle-icon--sun" aria-hidden="true">
				<svg viewBox="0 0 24 24" width="18" height="18" focusable="false" aria-hidden="true">
					<path d="M12 18a6 6 0 1 0 0-12 6 6 0 0 0 0 12Zm0-16 1 2h-2l1-2Zm0 20-1-2h2l-1 2ZM2 13l2-1v2l-2-1Zm20-1 2 1-2 1v-2ZM4.22 19.78l1.42-1.42 1.41 1.41-1.41 1.42-1.42-1.41Zm14.14-14.14 1.42-1.42 1.41 1.41-1.41 1.42-1.42-1.41ZM4.22 4.22 5.64 5.64 4.22 7.05 2.81 5.64 4.22 4.22Zm14.14 14.14 1.42 1.42-1.42 1.41-1.41-1.41 1.41-1.42Z"></path>
				</svg>
			</span>
		</button>

		<script is:inline>
			(function () {
				function getPreferredTheme() {
					return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
				}

				function getTheme() {
					var attr = document.documentElement.getAttribute('data-theme');
					if (attr === 'light' || attr === 'dark') return attr;
					try {
						var stored = localStorage.getItem('theme');
						if (stored === 'light' || stored === 'dark') return stored;
					} catch (e) {
						// ignore
					}
					return getPreferredTheme();
				}

				function updateFab() {
					var btn = document.getElementById('theme-toggle-fab');
					if (!btn) return;
					var theme = getTheme();
					var isDark = theme === 'dark';
					btn.setAttribute('aria-pressed', String(isDark));
					btn.setAttribute('aria-label', isDark ? '切换浅色模式' : '切换深色模式');
					btn.setAttribute('title', isDark ? '日间模式' : '夜间模式');
				}

				function setTheme(nextTheme) {
					document.documentElement.setAttribute('data-theme', nextTheme);
					try {
						localStorage.setItem('theme', nextTheme);
					} catch (e) {
						// ignore
					}
					updateFab();
				}

				function initFab() {
					var btn = document.getElementById('theme-toggle-fab');
					if (!btn) return;
					updateFab();
					btn.addEventListener('click', function () {
						var current = getTheme();
						setTheme(current === 'dark' ? 'light' : 'dark');
					});
				}

				if (document.readyState === 'loading') {
					document.addEventListener('DOMContentLoaded', initFab);
				} else {
					initFab();
				}
			})();
		</script>
	</body>
</html>
