---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import Base from './Base.astro';

type Props = CollectionEntry<'page'>['data'] & {
	content?: string;
};

const { title } = Astro.props;

// è·å–æ‰€æœ‰åšå®¢æ–‡ç« ç”¨äºæœç´¢
const allPosts = await getCollection('blog');
const posts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// åˆ›å»ºæœç´¢ç´¢å¼•æ•°æ®
const searchData = posts.map((post) => ({
	id: post.id,
	title: post.data.title,
	description: post.data.description || '',
	pubDate: post.data.pubDate.toISOString(),
	tags: post.data.tags || [],
	categories: post.data.categories || [],
}));
---

<Base
	title={title}
	description='æœç´¢åšå®¢æ–‡ç« '>
	<p></p>
	<h2>â€“</h2>
	<h1>{title}</h1>
	<div class='post-content content'>
		<slot />
	</div>

	<!-- æœç´¢åŒºåŸŸ -->
	<div class='search-container'>
		<div class='search-box'>
			<input
				type='text'
				id='search-input'
				placeholder='è¾“å…¥å…³é”®è¯æœç´¢æ–‡ç« ...'
				autocomplete='off'
			/>
		</div>

		<div
			id='search-stats'
			class='search-stats'>
		</div>

		<div
			id='search-results'
			class='search-results'>
			<!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
		</div>
	</div>

	<!-- æœç´¢æ•°æ® -->
	<script is:inline define:vars={{ searchData }}>
		// å­˜å‚¨æœç´¢æ•°æ®åˆ°å…¨å±€å˜é‡
		window.SEARCH_DATA = searchData;
	</script>

	<!-- æœç´¢åŠŸèƒ½ -->
	<script>
		const searchInput = document.getElementById('search-input') as HTMLInputElement;
		const searchResults = document.getElementById('search-results') as HTMLElement;
		const searchStats = document.getElementById('search-stats') as HTMLElement;

		// è·å–æœç´¢æ•°æ®
		const posts = (window as any).SEARCH_DATA;

		// æœç´¢å‡½æ•°
		function performSearch(query: string) {
			const keyword = query.trim().toLowerCase();

			if (!keyword) {
				searchResults.innerHTML = '';
				searchStats.innerHTML = '';
				return;
			}

			// æœç´¢é€»è¾‘ï¼šæ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€åˆ†ç±»
			const results = posts.filter((post: any) => {
				const titleMatch = post.title.toLowerCase().includes(keyword);
				const descMatch = post.description.toLowerCase().includes(keyword);
				const tagsMatch = post.tags.some((tag: string) => tag.toLowerCase().includes(keyword));
				const categoriesMatch = post.categories.some((cat: string) => cat.toLowerCase().includes(keyword));

				return titleMatch || descMatch || tagsMatch || categoriesMatch;
			});

			// æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
			searchStats.innerHTML = `æ‰¾åˆ° <strong>${results.length}</strong> ç¯‡ç›¸å…³æ–‡ç« `;

			// æ˜¾ç¤ºæœç´¢ç»“æœ
			if (results.length === 0) {
				searchResults.innerHTML = '<div class="no-results">ğŸ˜” æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ç« </div>';
			} else {
				const html = results
					.map((post: any) => {
						const date = new Date(post.pubDate);
						const formattedDate = `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}.${String(date.getDate()).padStart(2, '0')}`;

						// é«˜äº®å…³é”®è¯
						const highlightText = (text: string) => {
							const regex = new RegExp(`(${keyword})`, 'gi');
							return text.replace(regex, '<mark>$1</mark>');
						};

						return `
						<div class="result-item">
							<div class="result-header">
								<h3 class="result-title">
									<a href="/blog/${post.id}.html">${highlightText(post.title)}</a>
								</h3>
								<span class="result-date">${formattedDate}</span>
							</div>
							${post.description ? `<p class="result-description">${highlightText(post.description)}</p>` : ''}
							${
								post.tags.length > 0
									? `
								<div class="result-tags">
									${post.tags.map((tag: string) => `<span class="tag">${tag}</span>`).join('')}
								</div>
							`
									: ''
							}
						</div>
					`;
					})
					.join('');

				searchResults.innerHTML = html;
			}
		}

		searchInput.addEventListener('keypress', (e) => {
			if (e.key === 'Enter') {
				performSearch(searchInput.value);
			}
		});

		// å®æ—¶æœç´¢ï¼ˆå¯é€‰ï¼‰
		let searchTimeout: number;
		searchInput.addEventListener('input', () => {
			clearTimeout(searchTimeout);
			searchTimeout = window.setTimeout(() => {
				performSearch(searchInput.value);
			}, 300);
		});
	</script>
</Base>

<style>
	.search-container {
		margin: 2em auto;
	}

	#search-input {
		width: 100%;
		padding: 1em;
		border: 2px solid;
		outline: none;
		border-radius: 10px;
	}

	#search-input::placeholder {
		color: rgb(var(--gray));
		opacity: 0.6;
	}

	.search-stats {
		margin-bottom: 2em;
		padding: 1em 0;
		font-size: 1em;
	}

	.search-stats strong {
		color: rgb(var(--accent));
		font-weight: 700;
		font-size: 1.2em;
	}

	.search-results {
		display: grid;
		gap: 1.5em;
	}
</style>

<!-- å…¨å±€æ ·å¼ç”¨äºåŠ¨æ€æ’å…¥çš„å…ƒç´  -->
<style is:global>
	/* æœç´¢ç»“æœå¡ç‰‡ */
	.result-item {
		position: relative;
		padding: 1.5em;
		background: white;
		border: 2px solid transparent;
		border-color: rgba(var(--accent), 0.3);
		border-radius: 12px;
		transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		overflow: hidden;
	}

	.result-item::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		width: 4px;
		height: 0;
		background: linear-gradient(180deg, rgb(var(--accent)) 0%, rgba(var(--accent), 0.6) 100%);
		transition: height 0.3s ease;
	}

	.result-item:hover {
		border-color: rgba(var(--accent), 0.3);
		box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
		transform: translateY(-4px);
	}

	.result-item:hover::before {
		height: 100%;
	}

	.result-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		gap: 1.5em;
	}

	.result-title {
		margin: 0;
		font-size: 1.2em;
		font-weight: 600;
		flex: 1;
		line-height: 1.4;
	}

	.result-title a {
		text-decoration: none;
		transition: all 0.2s ease;
		background: linear-gradient(to right, rgb(var(--accent)) 0%, rgb(var(--accent)) 100%);
		background-size: 0 2px;
		background-repeat: no-repeat;
		background-position: left bottom;
		padding-bottom: 2px;
	}

	.result-title a:hover {
		color: rgb(var(--accent));
		background-size: 100% 2px;
	}

	.result-date {
		display: inline-flex;
		align-items: center;
		gap: 0.4em;
		padding: 0.4em 0.8em;
		color: #666;
		font-size: 0.85em;
		border-radius: 6px;
		white-space: nowrap;
		font-weight: 500;
	}

	.result-description {
		margin: 1em 0;
		color: rgb(var(--gray));
		line-height: 1.8;
		font-size: 0.95em;
	}

	.result-tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.6em;
	}

	.result-tags .tag {
		display: inline-flex;
		align-items: center;
		padding: 0.4em 1em 0.4em 0;
		border-radius: 20px;
		font-size: 0.85em;
		transition: all 0.2s ease;
	}

	.no-results {
		text-align: center;
		padding: 4em 2em;
		border-radius: 12px;
		font-size: 1.1em;
	}

	.no-results::before {
		content: 'ğŸ”';
		display: block;
		font-size: 4em;
		margin-bottom: 0.3em;
		opacity: 0.5;
	}

	/* å…³é”®è¯é«˜äº® */
	#search-results mark {
		background: linear-gradient(135deg, rgba(var(--accent), 0.25) 0%, rgba(var(--accent), 0.15) 100%);
		color: rgb(var(--accent));
		padding: 0.15em 0.3em;
		border-radius: 4px;
		font-weight: 700;
		box-shadow: 0 2px 4px rgba(var(--accent), 0.1);
	}

	/* åŠ è½½åŠ¨ç”» */
	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.result-item {
		animation: fadeIn 0.4s ease-out;
	}

	.result-item:nth-child(1) {
		animation-delay: 0.05s;
	}
	.result-item:nth-child(2) {
		animation-delay: 0.1s;
	}
	.result-item:nth-child(3) {
		animation-delay: 0.15s;
	}
	.result-item:nth-child(4) {
		animation-delay: 0.2s;
	}
	.result-item:nth-child(5) {
		animation-delay: 0.25s;
	}

	/* å“åº”å¼ */
	@media (max-width: 720px) {
		.result-header {
			flex-direction: column;
			gap: 0.8em;
		}

		.result-date {
			align-self: flex-start;
		}

		.result-title {
			font-size: 1.2em;
		}
	}
</style>
