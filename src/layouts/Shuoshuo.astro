---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import Base from './Base.astro';
import { marked } from 'marked';
import { INCLUDE_DRAFTS, filterDrafts } from '../utils/drafts';
import fs from 'fs';
import path from 'path';

type Props = CollectionEntry<'page'>['data'] & {
	content?: string;
};

const { title } = Astro.props;

// 读取 Markdown 文件中的碎碎念
const fileGossips = filterDrafts(await getCollection('gossips'));

// 读取 Mastodon 数据
let mastodonGossips: any[] = [];
try {
	const mastodonDataPath = path.join(process.cwd(), 'src/data/mastodon.json');
	if (fs.existsSync(mastodonDataPath)) {
		const mastodonData = JSON.parse(fs.readFileSync(mastodonDataPath, 'utf-8'));
		mastodonGossips = mastodonData.map((status: any) => ({
			data: {
				pubDate: new Date(status.created_at),
				slug: `mastodon-${status.id}`,
				draft: false,
				tag: 'mastodon',
			},
			body: status.content_markdown,
			_raw: status, // 保留原始数据用于扩展
		}));
	}
} catch (error) {
	console.warn('Failed to load Mastodon data:', error);
}

// 合并两个数据源并按日期排序
const gossips = [...fileGossips, ...mastodonGossips].sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const pageSize = 10;
const totalPages = gossips.length > 0 ? Math.ceil(gossips.length / pageSize) : 0;

marked.setOptions({
	breaks: true,
	gfm: true,
});

// 解析日期，返回 { day, month, year }
function getDateParts(date: Date) {
    const day = date.getDate().toString();
    const month = date.toLocaleString('en-US', { month: 'short' }).toUpperCase(); // JAN, FEB
    const year = date.getFullYear();
    return { day, month, year };
}
---

<link rel="stylesheet" href="/lightgallery/css/lightgallery.min.css" slot="head" />
<style is:global slot="head">
    .media-grid {
        display: grid;
        gap: 6px; /* Slightly larger gap for aesthetics */
        margin-top: 8px;
        border-radius: 0;
        overflow: hidden;
        width: 100%;
    }
    .media-item {
        display: block;
        position: relative;
        overflow: hidden;
        background-color: #f0f0f0;
        cursor: zoom-in;
    }
    .media-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        transition: transform 0.4s ease;
    }
    .media-item:hover img {
        transform: scale(1.03);
    }

    /* Grid Layouts - Compact & Harmonious */
    
    /* 1 Image: Max height limited, preserve aspect ratio */
    .grid-1 { 
        display: flex;
        background: transparent;
        border-radius: 0;
        overflow: visible;
    }
    .grid-1 .media-item {
        max-height: 320px;
        max-width: 100%;
        width: auto;
        border-radius: 0;
        border: 1px solid rgba(0,0,0,0.05);
    }
    .grid-1 .media-item img {
        object-fit: contain;
        max-height: 320px;
        width: auto;
    }

    /* 2 Images: Side by side (Landscape feel) */
    .grid-2 { 
        grid-template-columns: repeat(2, 1fr); 
        aspect-ratio: 5/2; 
    }
    
    /* 3 Images: 3 in a row (Panoramic feel) */
    .grid-3 { 
        grid-template-columns: repeat(3, 1fr); 
        aspect-ratio: 7/2; 
    }
    
    /* 4 Images: 2x2 Grid (Standard) */
    .grid-4 { 
        grid-template-columns: repeat(2, 1fr); 
        aspect-ratio: 3/2; 
    }
    
    /* Mobile adjustments */
    @media (max-width: 600px) {
        .media-grid { gap: 4px; border-radius: 0; }
        .grid-1 .media-item { border-radius: 0; max-height: 250px; }
        .grid-1 .media-item img { max-height: 250px; }
        .grid-2 { aspect-ratio: 2/1; }
        .grid-3 { aspect-ratio: 3/1; }
    }
</style>

<Base title={title} description={title}>
	<div class='gossip-page'>
        <p></p>
        <h2>–</h2>
        <!-- <h1>{title}</h1> -->

		<div id='shuoshuo' class="feed-container">
            {
                gossips.length === 0 ? (
                    <div class='empty-state'>暂无碎碎念</div>
                ) : (
                    gossips.map((gossip: any, index) => {
                        const { day, month, year } = getDateParts(gossip.data.pubDate);
                        const attachments = gossip._raw?.media_attachments || [];
                        return (
                            <div class='feed-item' data-index={index}>
                                <div class="date-col">
                                    <span class="date-month">{month}</span>
                                    <span class="date-day">{day}</span>
                                    <span class="date-year">{year}</span>
                                </div>
                                <div class='content-col'>
                                    <div class='feed-card'>
                                        <div class='card-body markdown-body' set:html={marked.parse(gossip.body || '')} />
                                        
                                        {attachments.length > 0 && (
                                            <div class={`media-grid grid-${Math.min(attachments.length, 4)}`}>
                                                {attachments.slice(0, 4).map((media: any) => (
                                                    <a href={media.url} class="media-item" data-src={media.url}  data-sub-html={media.description}>
                                                        <img src={media.preview_url || media.url} alt={media.description || ""} loading="lazy" />
                                                    </a>
                                                ))}
                                            </div>
                                        )}
                                        
                                        {INCLUDE_DRAFTS && gossip.data.draft && <div class="draft-indicator">DRAFT</div>}
                                    </div>
                                </div>
                            </div>
                        )
                    })
                )
            }
		</div>
        
		{totalPages > 1 && (
			<nav class='pagination' id='shuoshuo-pagination' aria-label='分页'>
                <div class='pagination-pages'>
					{Array.from({ length: totalPages }, (_, index) => {
						const pageNumber = index + 1;
						return (
							<a class='page-link' href={`?page=${pageNumber}`} data-page={pageNumber}>
								{pageNumber}
							</a>
						);
					})}
				</div>
			</nav>
		)}
	</div>

    <script is:inline src="/lightgallery/js/lightgallery.min.js"></script>
    <script is:inline>
        // Init LightGallery
        function initGallery() {
            const grids = document.querySelectorAll('.media-grid');
            grids.forEach(grid => {
                if (window.lightGallery) {
                    window.lightGallery(grid, {
                        selector: '.media-item',
                        speed: 500,
                        download: false
                    });
                }
            });
        }
        
        // Init immediately if ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initGallery);
        } else {
            initGallery();
        }
    </script>

	<script is:inline define:vars={{ pageSize, totalPages }}>
		(() => {
			const items = Array.from(document.querySelectorAll('#shuoshuo .feed-item'));
			const pagination = document.getElementById('shuoshuo-pagination');
			const pageLinks = Array.from(document.querySelectorAll('#shuoshuo-pagination a[data-page]'));

			if (!pagination || !items.length || totalPages <= 1) {
				if (pagination) pagination.style.display = 'none';
				return;
			}

			const params = new URLSearchParams(window.location.search);
			const initialPage = Math.min(totalPages, Math.max(1, Number(params.get('page')) || 1));
			const clampPage = (page) => Math.min(totalPages, Math.max(1, page));

			function renderPage(page) {
				const currentPage = clampPage(page);
				const start = (currentPage - 1) * pageSize;
				const end = start + pageSize;

				items.forEach((item, index) => {
					const visible = index >= start && index < end;
					item.style.display = visible ? 'flex' : 'none';
				});

				pageLinks.forEach((link) => {
					const linkPage = Number(link.dataset.page);
					link.classList.toggle('active', linkPage === currentPage);
				});

				params.set('page', String(currentPage));
				const nextUrl = `${window.location.pathname}?${params.toString()}${window.location.hash}`;
				window.history.replaceState({}, '', nextUrl);
                
                if (window.scrollY > 100) {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
			}

			renderPage(initialPage);

			pageLinks.forEach((link) => {
				link.addEventListener('click', (event) => {
					event.preventDefault();
					const targetPage = Number(link.dataset.page);
					if (!Number.isFinite(targetPage)) return;
					renderPage(targetPage);
				});
			});
		})();
	</script>

	<style>
        .gossip-page {
            max-width: 820px;
            margin: 0 auto;
            padding-bottom: 4rem;
        }

        /* 1. Header (Minimal Journal Style) - Removed */
        
        /* Feed Container */
        .feed-container {
            /* 不再需要额外的 margin-top，因为 header 已经有 margin-bottom */
        }

        /* 2. Grid Layout */
        .feed-item {
            display: flex;
            gap: 16px;
            margin-bottom: 1.5rem;
            align-items: flex-start;
        }

        /* 3. Date Column */
        .date-col {
            flex-shrink: 0;
            width: 36px;
            text-align: left;
            display: flex;
            flex-direction: column;
            padding-top: 4px;
        }

        .date-month {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--gray-color);
            letter-spacing: 0.05em;
            text-transform: uppercase;
            line-height: 1;
            margin-bottom: 2px;
        }

        .date-day {
            font-family: "Source Serif 4", "Noto Serif SC", serif;
            font-size: 1.35rem;
            font-weight: 500;
            color: var(--heading-color);
            line-height: 1;
        }

        .date-year {
            font-size: 0.65rem;
            color: var(--gray-color);
            opacity: 0.6;
            margin-top: 2px;
        }

        /* 4. Content Column */
        .content-col {
            flex: 1;
            min-width: 0;
        }

        .feed-card {
            position: relative;
            background-color: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1); 
            border-radius: 0;
            padding: 0.75rem 1rem; 
            transition: all 0.2s ease;
        }
        
        :root[data-theme="dark"] .feed-card {
            border-color: rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.02);
        }

        .feed-card:hover {
            border-color: rgba(0, 0, 0, 0.25);
            background: rgba(0, 0, 0, 0.01);
        }

        :root[data-theme="dark"] .feed-card:hover {
            border-color: rgba(255, 255, 255, 0.25);
            background: rgba(255, 255, 255, 0.04);
        }

        /* 5. Typography */
        .card-body {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-color);
            letter-spacing: 0.01em; 
        }

        .card-body :global(p) {
            margin: 0.35rem 0;
        }
        .card-body :global(p:first-child) {
            margin-top: 0;
        }
        .card-body :global(p:last-child) {
            margin-bottom: 0;
        }
        
        .card-body :global(strong) {
            font-weight: 600;
            color: var(--heading-color);
        }

        .card-body :global(img) {
            max-width: 100%;
            border-radius: 0;
            border: 1px solid rgba(0,0,0,0.08);
            margin-top: 0.8rem;
            opacity: 0.95; 
            transition: opacity 0.2s;
        }
        
        .card-body :global(img):hover {
            opacity: 1;
        }
        
        .card-body :global(blockquote) {
             margin: 0.4rem 0;
             padding-left: 0.6rem;
             border-left: 2px solid rgba(0,0,0,0.15);
             color: var(--gray-color);
             font-size: 0.85rem;
             font-style: normal;
        }
        
        .draft-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 0.6rem;
            color: #d97706;
            opacity: 0.6;
            font-weight: bold;
            letter-spacing: 0.05em;
        }

        /* Pagination */
		.pagination {
			display: flex;
			justify-content: center;
			margin-top: 3rem;
		}

		.page-link {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			width: 32px;
			height: 32px;
			margin: 0 4px;
            font-size: 0.85rem;
			color: var(--gray-color);
			text-decoration: none;
            border-radius: 0;
            transition: all 0.2s;
		}

		.page-link:hover {
            color: var(--heading-color);
            background: rgba(0,0,0,0.05);
		}
        
        :root[data-theme="dark"] .page-link:hover {
            background: rgba(255,255,255,0.1);
        }

		.page-link.active {
            color: var(--heading-color);
            font-weight: 700;
            background: transparent;
            box-shadow: 0 1px 0 0 var(--heading-color);
            border-radius: 0;
		}

        /* Mobile */
        @media (max-width: 600px) {
            .gossip-page {
                padding: 0;
            }
            
            .feed-item {
                gap: 12px;
            }
            
            .date-col {
                width: 32px;
            }
            
            .date-day {
                font-size: 1.25rem;
            }
            
            .feed-card {
                padding: 0.85rem;
            }
        }
	</style>
</Base>
