---
import type { CollectionEntry } from 'astro:content';
import { getCollection } from 'astro:content';
import Base from './Base.astro';
import { marked } from 'marked';

type Props = CollectionEntry<'page'>['data'] & {
	content?: string;
};

const { title } = Astro.props;

const gossips = (await getCollection('gossips'))
	.filter((item) => !item.data.draft)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

marked.setOptions({
	breaks: true,
	gfm: true,
});

function formatDate(date: Date): string {
	return date.toLocaleDateString('zh-CN', {
		year: 'numeric',
		month: '2-digit',
		day: '2-digit',
	});
}
---

<Base title={title} description={title}>
	<p></p>
	<h2>–</h2>
	<h1>{title}</h1>
	<div class='post-content content'>
		<slot />

		<div id='shuoshuo'>
			<ul>
				{
					gossips.length === 0 ? (
						<li class='empty'>暂无说说</li>
					) : (
						gossips.map((gossip) => (
							<li class='comment'>
								<div class='meta'>
									<span class='date'>{formatDate(gossip.data.pubDate)}</span>
									{gossip.data.tag && <span class='tag'>#{gossip.data.tag}</span>}
								</div>
								<div class='body' set:html={marked.parse(gossip.body)} />
							</li>
						))
					)
				}
			</ul>
		</div>
	</div>
</Base>
