---
import type { CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import Base from './Base.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Comments from '../components/Comments.astro';
import Toc from '../components/Toc.astro';
import NavButton from '../components/NavButton.astro';

type Props = CollectionEntry<'blog'>['data'] & {
	postId?: string;
	showTOC?: boolean; // 是否显示目录，默认 true
	tocMinLevel?: number; // 目录最小层级，默认 2 (h2)
	tocMaxLevel?: number; // 目录最大层级，默认 3 (h3)
};

const {
	title,
	description,
	pubDate,
	updatedDate,
	heroImage,
	tags,
	categories,
	postId,
	showTOC = true,
	tocMinLevel = 2,
	tocMaxLevel = 3,
} = Astro.props;
---

<Base title={title} description={description || ''}>
	<!-- LightGallery CSS (本地) -->
	<link rel='stylesheet' href='/lightgallery/css/lightgallery.min.css' slot='head' />

	<style is:global>
		/* 代码块复制按钮样式 */
		.copy-code-button {
			position: absolute;
			top: 0.5rem;
			right: 0.5rem;
			background-color: #f0f0f0;
			border: 1px solid #ddd;
			border-radius: 4px;
			padding: 0.25rem 0.5rem;
			font-size: 0.8rem;
			cursor: pointer;
			opacity: 0.6;
			transition: opacity 0.2s;
			z-index: 10;
		}

		.copy-code-button:hover {
			background-color: #e0e0e0;
		}

		.copy-code-button.copied {
			background-color: #4caf50;
			color: white;
		}

		/* 当鼠标悬停在代码块上时显示复制按钮 */
		pre:hover .copy-code-button {
			opacity: 1;
		}

		/* 代码块容器相对定位 */
		pre {
			position: relative;
		}
	</style>

	<p></p>
	<h2>–</h2>
	{
		heroImage && (
			<div class='hero-image'>
				<Image src={heroImage} alt={title} />
			</div>
		)
	}
	<h1 transition:name={postId ? `post-title-${postId}` : undefined} class="post-title">{title}</h1>
	<div class="post-meta" role="note" aria-label="文章信息">
		<div class="post-meta__row">
			<span class="post-meta__label">发布于</span>
			<span class="post-meta__value"><FormattedDate date={pubDate} /></span>
		</div>

		{categories && categories.length > 0 && (
			<div class="post-meta__row">
				<span class="post-meta__label">分类</span>
				<span class="post-meta__chips">
					{categories.map((category) => (
						<a href={`/categories/${category}/`} class="tag">
							{category}
						</a>
					))}
				</span>
			</div>
		)}

		{tags && tags.length > 0 && (
			<div class="post-meta__row">
				<span class="post-meta__label">标签</span>
				<span class="post-meta__chips">
					{tags.map((tag) => (
						<a href={`/tags/${tag}/`} class="tag">
							#{tag}
						</a>
					))}
				</span>
			</div>
		)}
	</div>

	<div class='blog-layout'>
		<!-- 目录侧边栏 -->
		{
			showTOC && (
				<div class='blog-sidebar'>
					<Toc minLevel={tocMinLevel} maxLevel={tocMaxLevel} title='目录' />
				</div>
			)
		}

		<!-- 主内容区 -->
		<div class='post-content content' id='lightgallery'>
			<hr />
			<slot />
		</div>

		<!-- 导航按钮 -->
		<NavButton showBackToTop={true} />

		<Comments showLinuxDo={false} />
	</div>

	<!-- LightGallery JS (本地) -->
	<script is:inline src='/lightgallery/js/lightgallery.min.js'></script>

	<!-- 初始化 LightGallery -->
	<script is:inline>
		// 用于存储 lightGallery 实例
		let lgInstance = null;

		function initLightGallery() {
			// 销毁之前的实例（如果存在）
			if (lgInstance) {
				try {
					lgInstance.destroy(true);
				} catch (e) {
					console.log('清理旧实例');
				}
				lgInstance = null;
			}

			// 为文章内容中的所有图片添加链接包装
			const postContent = document.querySelector('.post-content');
			if (postContent) {
				const images = postContent.querySelectorAll('img');
				images.forEach(function (img) {
					// 将 src 属性改为 data-src 以支持懒加载
					const src = img.src;

					// 如果图片已经被链接包裹，则跳过
					if (img.parentElement.tagName === 'A') {
						return;
					}

					// 创建链接元素
					const link = document.createElement('a');
					link.href = src; // 使用原始的 src 作为链接地址
					link.className = 'no-link';
					link.setAttribute('data-sub-html', img.alt || '');

					// 将图片包装在链接中
					img.parentNode.insertBefore(link, img);
					link.appendChild(img);

				});

				// 初始化 lightGallery
				const container = document.getElementById('lightgallery');
				if (container && typeof lightGallery !== 'undefined') {
					lgInstance = lightGallery(container, {
						selector: 'a[href$=".jpg"], a[href$=".jpeg"], a[href$=".png"], a[href$=".gif"], a[href$=".webp"]',
						mode: 'lg-fade',
						cssEasing: 'ease',
						speed: 600,
						hideBarsDelay: 2000,
						controls: true,
						// mousewheel: true,
						download: true,
						counter: true,
						thumbnail: true,
					});
				}
			}
		}

		// 首次加载时初始化
		document.addEventListener('DOMContentLoaded', initLightGallery);

		// 支持 Astro View Transitions（如果启用的话）
		document.addEventListener('astro:page-load', initLightGallery);

		// 在页面切换前清理
		document.addEventListener('astro:before-preparation', function () {
			if (lgInstance) {
				try {
					lgInstance.destroy(true);
				} catch (e) {
					console.log('清理实例');
				}
				lgInstance = null;
			}
		});
	</script>

	<script is:inline>
		// 添加复制按钮到代码块
		function addCopyButtons() {
			const codeBlocks = document.querySelectorAll('pre:not(.code-block-added)');
			codeBlocks.forEach((block) => {
				// 标记已处理的代码块，避免重复添加
				block.classList.add('code-block-added');

				// 创建复制按钮
				const button = document.createElement('button');
				button.className = 'copy-code-button';
				button.textContent = '复制';
				button.setAttribute('aria-label', '复制代码');

				// 添加点击事件
				button.addEventListener('click', async () => {
					try {
						// 获取代码内容
						const code = block.querySelector('code');
						if (code) {
							const text = code.innerText;
							await navigator.clipboard.writeText(text);

							// 更新按钮状态
							button.textContent = '已复制';
							button.classList.add('copied');

							// 2秒后恢复原状态
							setTimeout(() => {
								button.textContent = '复制';
								button.classList.remove('copied');
							}, 2000);
						}
					} catch (err) {
						console.error('复制失败:', err);
						button.textContent = '失败';
						setTimeout(() => {
							button.textContent = '复制';
						}, 2000);
					}
				});

				// 将按钮添加到代码块
				block.appendChild(button);
			});
		}

		window.addEventListener('DOMContentLoaded', function () {
			// 初始化复制按钮
			addCopyButtons();
		});

		// 支持 Astro View Transitions（如果启用的话）
		document.addEventListener('astro:page-load', function () {
			addCopyButtons();
		});
	</script>

</Base>

<style>
	.hero-image {
		width: 100%;
		max-width: 100%;
		margin: 0 0 1rem 0;
	}
	.hero-image :global(img) {
		display: block;
		margin: 0 auto;
		border-radius: 12px;
		box-shadow: var(--box-shadow);
	}
	.post-title {
		margin-top: 0.5rem;
	}
</style>
