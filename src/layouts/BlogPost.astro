---
import type { CollectionEntry } from 'astro:content';
import Base from './Base.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Toc from '../components/Toc.astro';
import LeftSidebar from '../components/LeftSidebar.astro';
import NavButton from '../components/NavButton.astro';
import Changelog from '../components/Changelog.astro';

type Props = CollectionEntry<'blog'>['data'] & {
	postId?: string;
	showTOC?: boolean; // 是否显示目录，默认 true
	tocMinLevel?: number; // 目录最小层级，默认 2 (h2)
	tocMaxLevel?: number; // 目录最大层级，默认 3 (h3)
	readingTime?: number; // 阅读时间（分钟）
};

const {
	title,
	description,
	pubDate,
	updatedDate,
	heroImage,
	tags,
	categories,
	draft,
	changelog,
	postId,
	showTOC = true,
	tocMinLevel = 2,
	tocMaxLevel = 3,
	readingTime,
} = Astro.props;

const isDev = import.meta.env.DEV;
---

<Base title={title} description={description || ''}>
	<!-- LightGallery CSS (本地) -->
	<link rel='stylesheet' href='/lightgallery/css/lightgallery.min.css' slot='head' />

	<style is:global>
		/* 文章结束标识 */
		.post-end {
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 0.8rem;
			margin: 3rem 0 0;
			padding: 1.5rem 0 0.8rem;
			color: var(--gray-color);
			font-size: 0.85rem;
			letter-spacing: 0.15em;
		}

		.post-end__symbol {
			font-size: 0.5rem;
			opacity: 0.6;
		}

		.post-end__text {
			font-family: "Source Serif 4", serif;
			font-weight: 500;
		}

		/* Code Block Wrapper */
		.code-wrapper {
			position: relative;
			margin: 2rem 0;
			border-radius: 0;
			background: var(--code-background-color);
			box-shadow: none;
			border: 1px solid rgba(0, 0, 0, 0.06);
			overflow: hidden;
		}

		:root[data-theme="dark"] .code-wrapper {
			border-color: rgba(255, 255, 255, 0.08);
		}

		/* Header - Immersive Style */
		.code-header {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 2.5rem;
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 0 1rem;
			background: transparent;
			z-index: 10;
			/* 让鼠标事件穿透 Header 背景，但保留按钮的交互 */
			pointer-events: none;
		}

		.code-header > * {
			pointer-events: auto;
		}

		/* Code block decorative dots - 克制的单色风格 */
		.mac-buttons {
			display: flex;
			gap: 6px;
		}

		.mac-button {
			width: 9px;
			height: 9px;
			border-radius: 50%;
			background-color: var(--gray-color);
			opacity: 0.2;
		}

		/* Language Label */
		.code-lang {
			font-size: 0.75rem;
			color: var(--gray-color);
			font-family: "JetBrains Mono", "Fira Code", consolas, Menlo, monospace;
			text-transform: uppercase;
			font-weight: 600;
			position: absolute;
			left: 50%;
			transform: translateX(-50%);
			opacity: 0.5;
			user-select: none;
		}

		/* 文章标题上方装饰分隔线 */
		.post-title-separator {
			color: var(--gray-color);
			opacity: 0.3;
			font-size: 1.2rem;
			margin: 0.5rem 0 0.8rem;
			user-select: none;
		}

		/* Copy Button */
		.copy-btn {
			display: inline-flex;
			align-items: center;
			justify-content: center;
			background: transparent;
			border: none;
			color: var(--gray-color);
			cursor: pointer;
			padding: 4px;
			border-radius: 0;
			transition: all 0.2s;
			opacity: 0.0; /* 默认隐藏，悬停显示 */
		}

		.code-wrapper:hover .copy-btn {
			opacity: 0.7;
		}

		.copy-btn:hover {
			background: rgba(0, 0, 0, 0.05);
			color: var(--text-color);
			opacity: 1 !important;
		}

		.copy-btn.copied {
			color: #4caf50;
			opacity: 1 !important;
		}

		:root[data-theme="dark"] .copy-btn:hover {
			background: rgba(255, 255, 255, 0.1);
		}

		/* Pre override inside wrapper */
		.code-wrapper pre {
			margin: 0 !important;
			border-radius: 0 !important;
			padding: 2.5rem 1rem 1rem 1rem !important; /* Top padding for header space */
			background: transparent !important;
		}

	</style>

	<div class="post-title-separator" aria-hidden="true">–</div>
	<h1 class="post-title" transition:name={postId ? `post-title-${postId}` : undefined}>{title}</h1>
		<div class="post-meta" role="note" aria-label="文章信息">
			<FormattedDate date={pubDate} />
			{readingTime && (
				<>
					<span class="post-meta__separator">·</span>
					<span class="post-meta__reading-time">约 {readingTime} 分钟</span>
				</>
			)}
			{isDev && draft && <span class="draft-badge" aria-label="草稿">草稿</span>}

			{categories && categories.length > 0 && (
				<>
					<span class="post-meta__separator">·</span>
					{categories.map((category) => (
						<a href={`/categories/${category}/`} class="post-meta__category">
							{category}
						</a>
					))}
				</>
			)}

			{tags && tags.length > 0 && (
				<>
					<span class="post-meta__separator">·</span>
					{tags.map((tag) => (
						<a href={`/tags/${tag}/`} class="post-meta__tag">
							#{tag}
						</a>
					))}
				</>
			)}
		</div>

	<div class={`blog-layout ${showTOC ? 'has-sidebar' : ''}`}>
		
		<LeftSidebar details={{ pubDate, readingTime }} />

		<div class="blog-main-column">
			<!-- 主内容区 -->
			<div class='post-content content' id='lightgallery'>
				<slot />
			</div>

		<!-- 文章结束标识 -->
		<div class='post-end'>
			<span class='post-end__symbol'>◆</span>
			<span class='post-end__text'>END</span>
			<span class='post-end__symbol'>◆</span>
		</div>

		<!-- Changelog 注脚 -->
		{changelog && changelog.length > 0 && (
			<Changelog entries={changelog} />
		)}

		<!-- 导航按钮 -->
		<NavButton showBackToTop={true} />
		</div>

		<!-- 目录侧边栏 -->
		{
			showTOC && (
				<div class='blog-sidebar'>
					<Toc minLevel={tocMinLevel} maxLevel={tocMaxLevel} title='目录' />
				</div>
			)
		}
	</div>

	<!-- LightGallery JS (本地) -->
	<script is:inline src='/lightgallery/js/lightgallery.min.js'></script>

	<!-- 初始化 LightGallery -->
	<script is:inline>
		// 用于存储 lightGallery 实例
		let lgInstance = null;

		function initLightGallery() {
			// 销毁之前的实例（如果存在）
			if (lgInstance) {
				try {
					lgInstance.destroy(true);
				} catch (e) {
					console.log('清理旧实例');
				}
				lgInstance = null;
			}

			// 为文章内容中的所有图片添加链接包装
			const postContent = document.querySelector('.post-content');
			if (postContent) {
				const images = postContent.querySelectorAll('img');
				images.forEach(function (img) {
					// 将 src 属性改为 data-src 以支持懒加载
					const src = img.src;

					// 如果图片已经被链接包裹，则跳过
					if (img.parentElement.tagName === 'A') {
						return;
					}

					// 创建链接元素
					const link = document.createElement('a');
					link.href = src; // 使用原始的 src 作为链接地址
					link.className = 'no-link';
					link.setAttribute('data-sub-html', img.alt || '');

					// 将图片包装在链接中
					img.parentNode.insertBefore(link, img);
					link.appendChild(img);

				});

				// 初始化 lightGallery
				const container = document.getElementById('lightgallery');
				if (container && typeof lightGallery !== 'undefined') {
					lgInstance = lightGallery(container, {
						selector: 'a[href$=".jpg"], a[href$=".jpeg"], a[href$=".png"], a[href$=".gif"], a[href$=".webp"]',
						mode: 'lg-fade',
						cssEasing: 'ease',
						speed: 600,
						hideBarsDelay: 2000,
						controls: true,
						// mousewheel: true,
						download: true,
						counter: true,

						thumbnail: true,
					});
				}
			}
		}

		// 首次加载时初始化
		document.addEventListener('DOMContentLoaded', initLightGallery);

		// 支持 Astro View Transitions（如果启用的话）
		document.addEventListener('astro:page-load', initLightGallery);

		// 在页面切换前清理
		document.addEventListener('astro:before-preparation', function () {
			if (lgInstance) {
				try {
					lgInstance.destroy(true);
				} catch (e) {
					console.log('清理实例');
				}
				lgInstance = null;
			}
		});
	</script>

	<script is:inline>
		// 添加复制按钮和语言标签到代码块
		function addCopyButtons() {
			const codeBlocks = document.querySelectorAll('pre:not(.code-block-added)');
			codeBlocks.forEach((block) => {
				// 标记已处理的代码块
				block.classList.add('code-block-added');

				// 创建包装容器
				const wrapper = document.createElement('div');
				wrapper.className = 'code-wrapper';

				// 插入包装器并移动 pre
				if (block.parentNode) {
					block.parentNode.insertBefore(wrapper, block);
					wrapper.appendChild(block);
				}

				// 创建头部
				const header = document.createElement('div');
				header.className = 'code-header';

				// Mac 风格按钮
				const macButtons = document.createElement('div');
				macButtons.className = 'mac-buttons';
				['close', 'minimize', 'maximize'].forEach(type => {
					const btn = document.createElement('div');
					btn.className = `mac-button ${type}`;
					macButtons.appendChild(btn);
				});

				// 获取 code 元素（在 forEach 顶层定义，供后续复制功能使用）
				const code = block.querySelector('code');

				// 获取语言
				let lang = '';
				// 尝试从 pre 的 data-language 属性获取
				if (block.dataset.language) {
					lang = block.dataset.language;
				}
				// 尝试从 code 的 class 获取
				else if (code) {
					const classList = code.className.split(' ');
					const langClass = classList.find(c => c.startsWith('language-'));
					if (langClass) {
						lang = langClass.replace('language-', '');
					}
				}

				// 语言标签
				const langLabel = document.createElement('span');
				langLabel.className = 'code-lang';
				langLabel.textContent = lang;

				// 复制按钮
				const copyBtn = document.createElement('button');
				copyBtn.className = 'copy-btn';
				copyBtn.setAttribute('aria-label', '复制');
				copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';

				// 复制功能
				copyBtn.addEventListener('click', async () => {
					try {
						if (code) {
							const text = code.innerText;
							await navigator.clipboard.writeText(text);

							copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
							copyBtn.classList.add('copied');

							setTimeout(() => {
								copyBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
								copyBtn.classList.remove('copied');
							}, 2000);
						}
					} catch (err) {
						console.error('复制失败:', err);
					}
				});

				header.appendChild(macButtons);
				header.appendChild(langLabel);
				header.appendChild(copyBtn);

				// 将头部添加到包装器最前面
				wrapper.insertBefore(header, block);
			});
		}

		window.addEventListener('DOMContentLoaded', function () {
			// 初始化复制按钮
			addCopyButtons();
		});

		// 支持 Astro View Transitions（如果启用的话）
		document.addEventListener('astro:page-load', function () {
			addCopyButtons();
		});
	</script>

</Base>
