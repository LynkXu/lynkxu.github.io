---
import { getCollection } from 'astro:content';

// è·å–æ‰€æœ‰åšå®¢æ–‡ç« ç”¨äºæœç´¢
const allPosts = (await getCollection('blog')).filter((post) => !post.data.draft);
const posts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// åˆ›å»ºæœç´¢ç´¢å¼•æ•°æ®
const searchData = posts.map((post) => ({
	id: post.id,
	title: post.data.title,
	description: post.data.description || '',
	pubDate: post.data.pubDate.toISOString(),
	tags: post.data.tags || [],
	categories: post.data.categories || [],
}));
---

<!-- æœç´¢å¼¹çª— -->
<div id="search-modal" class="search-modal">
	<div class="search-modal-overlay"></div>
	<div class="search-modal-content">
		<div class="search-modal-header">
			<div class="search-box">
				<svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
					<circle cx="11" cy="11" r="8"></circle>
					<path d="m21 21-4.35-4.35"></path>
				</svg>
				<input type="text" id="modal-search-input" placeholder="æœç´¢æ–‡ç« ..." autocomplete="off" />
				<button class="close-btn" id="close-search-modal" aria-label="å…³é—­æœç´¢">
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<line x1="18" y1="6" x2="6" y2="18"></line>
						<line x1="6" y1="6" x2="18" y2="18"></line>
					</svg>
				</button>
			</div>
		</div>

		<div id="modal-search-stats" class="search-stats"></div>

		<div id="modal-search-results" class="search-results">
			<div class="search-tips">
				<p>ğŸ’¡ æ”¯æŒæœç´¢ï¼šæ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€åˆ†ç±»</p>
				<p>âŒ¨ï¸ æŒ‰ <kbd>Esc</kbd> å…³é—­å¼¹çª—</p>
			</div>
		</div>
	</div>
</div>

<!-- æœç´¢æ•°æ® -->
<script is:inline define:vars={{ searchData }}>
	window.SEARCH_DATA = searchData;
</script>

<!-- æœç´¢åŠŸèƒ½ -->
<script is:inline>
	function initSearchModal() {
		const searchModal = document.getElementById('search-modal');
		const searchInput = document.getElementById('modal-search-input');
		const searchResults = document.getElementById('modal-search-results');
		const searchStats = document.getElementById('modal-search-stats');
		const closeBtn = document.getElementById('close-search-modal');
		const overlay = document.querySelector('.search-modal-overlay');

		if (!searchModal || !searchInput || !searchResults || !searchStats || !closeBtn || !overlay) {
			return;
		}

		// è·å–æœç´¢æ•°æ®
		const posts = window.SEARCH_DATA || [];

		// æ‰“å¼€å¼¹çª—
		window.openSearchModal = function() {
			searchModal.classList.add('active');
			document.body.style.overflow = 'hidden';
			setTimeout(function() { searchInput.focus(); }, 100);
		};

		// å…³é—­å¼¹çª—
		function closeSearchModal() {
			searchModal.classList.remove('active');
			document.body.style.overflow = '';
			searchInput.value = '';
			searchResults.innerHTML = '<div class="search-tips"><p>ğŸ’¡ æ”¯æŒæœç´¢ï¼šæ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€åˆ†ç±»</p><p>âŒ¨ï¸ æŒ‰ <kbd>Esc</kbd> å…³é—­å¼¹çª—</p></div>';
			searchStats.innerHTML = '';
		}

		// æœç´¢å‡½æ•°
		function performSearch(query) {
			const keyword = query.trim().toLowerCase();

			if (!keyword) {
				searchResults.innerHTML = '<div class="search-tips"><p>ğŸ’¡ æ”¯æŒæœç´¢ï¼šæ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€åˆ†ç±»</p><p>âŒ¨ï¸ æŒ‰ <kbd>Esc</kbd> å…³é—­å¼¹çª—</p></div>';
				searchStats.innerHTML = '';
				return;
			}

			// æœç´¢é€»è¾‘ï¼šæ ‡é¢˜ã€æè¿°ã€æ ‡ç­¾ã€åˆ†ç±»
			const results = posts.filter(function(post) {
				const titleMatch = post.title.toLowerCase().includes(keyword);
				const descMatch = post.description.toLowerCase().includes(keyword);
				const tagsMatch = post.tags.some(function(tag) { return tag.toLowerCase().includes(keyword); });
				const categoriesMatch = post.categories.some(function(cat) { return cat.toLowerCase().includes(keyword); });

				return titleMatch || descMatch || tagsMatch || categoriesMatch;
			});

			// æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
			searchStats.innerHTML = 'æ‰¾åˆ° <strong>' + results.length + '</strong> ç¯‡ç›¸å…³æ–‡ç« ';

			// æ˜¾ç¤ºæœç´¢ç»“æœ
			if (results.length === 0) {
				searchResults.innerHTML = '<div class="no-results">ğŸ˜” æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ç« </div>';
			} else {
				const html = results
					.map(function(post) {
						const date = new Date(post.pubDate);
						const formattedDate = date.getFullYear() + '.' + String(date.getMonth() + 1).padStart(2, '0') + '.' + String(date.getDate()).padStart(2, '0');

						// é«˜äº®å…³é”®è¯
						function highlightText(text) {
							const regex = new RegExp('(' + keyword + ')', 'gi');
							return text.replace(regex, '<mark>$1</mark>');
						}

						var tagsHtml = '';
						if (post.tags.length > 0) {
							tagsHtml = '<div class="result-tags">' + 
								post.tags.map(function(tag) { return '<span class="tag">' + tag + '</span>'; }).join('') + 
								'</div>';
						}

						return '<div class="result-item">' +
							'<div class="result-header">' +
								'<h3 class="result-title">' +
									'<a href="/blog/' + post.id + '.html">' + highlightText(post.title) + '</a>' +
								'</h3>' +
								'<span class="result-date">' + formattedDate + '</span>' +
							'</div>' +
							(post.description ? '<p class="result-description">' + highlightText(post.description) + '</p>' : '') +
							tagsHtml +
						'</div>';
					})
					.join('');

				searchResults.innerHTML = html;
			}
		}

		// äº‹ä»¶ç›‘å¬
		closeBtn.addEventListener('click', closeSearchModal);
		overlay.addEventListener('click', closeSearchModal);

		// é”®ç›˜äº‹ä»¶
		document.addEventListener('keydown', function(e) {
			// Cmd/Ctrl + K æ‰“å¼€æœç´¢
			if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
				e.preventDefault();
				window.openSearchModal();
			}
			// Esc å…³é—­æœç´¢
			if (e.key === 'Escape' && searchModal.classList.contains('active')) {
				closeSearchModal();
			}
		});

		// æœç´¢è¾“å…¥äº‹ä»¶
		searchInput.addEventListener('keypress', function(e) {
			if (e.key === 'Enter') {
				performSearch(searchInput.value);
			}
		});

		// å®æ—¶æœç´¢
		var searchTimeout;
		searchInput.addEventListener('input', function() {
			clearTimeout(searchTimeout);
			searchTimeout = setTimeout(function() {
				performSearch(searchInput.value);
			}, 300);
		});
	}

	// DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initSearchModal);
	} else {
		initSearchModal();
	}
</script>

<style>
	.search-modal {
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		z-index: 9999;
		display: none;
		align-items: flex-start;
		justify-content: center;
		padding-top: 10vh;
	}

	.search-modal.active {
		display: flex;
	}

	.search-modal-overlay {
		position: absolute;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.5);
		backdrop-filter: blur(4px);
		animation: fadeIn 0.2s ease;
	}

	.search-modal-content {
		position: relative;
		width: 90%;
		max-width: 700px;
		max-height: 80vh;
		background: white;
		border-radius: 16px;
		box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
		display: flex;
		flex-direction: column;
		animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		overflow: hidden;
	}

	.search-modal-header {
		padding: 1.5rem;
		border-bottom: 1px solid #eee;
		flex-shrink: 0;
	}

	.search-box {
		display: flex;
		align-items: center;
		gap: 0.75rem;
		position: relative;
	}

	.search-icon {
		color: rgb(var(--gray));
		flex-shrink: 0;
	}

	#modal-search-input {
		flex: 1;
		padding: 0.75rem 0;
		border: none;
		outline: none;
		font-size: 1.1rem;
		background: transparent;
	}

	#modal-search-input::placeholder {
		color: rgb(var(--gray));
		opacity: 0.6;
	}

	.close-btn {
		padding: 0.5rem;
		border: none;
		background: transparent;
		cursor: pointer;
		color: rgb(var(--gray));
		border-radius: 8px;
		transition: all 0.2s;
		display: flex;
		align-items: center;
		justify-content: center;
		flex-shrink: 0;
	}

	.close-btn:hover {
		background: rgba(var(--accent), 0.1);
		color: rgb(var(--accent));
	}

	.search-stats {
		padding: 0 1.5rem;
		margin-top: 1rem;
		font-size: 0.95rem;
		color: rgb(var(--gray));
		flex-shrink: 0;
	}

	.search-stats strong {
		color: rgb(var(--accent));
		font-weight: 700;
		font-size: 1.2em;
	}

	.search-results {
		flex: 1;
		overflow-y: auto;
		padding: 1rem 1.5rem 1.5rem;
	}

	.search-tips {
		text-align: center;
		padding: 3rem 1rem;
		color: rgb(var(--gray));
	}

	.search-tips p {
		margin: 0.5rem 0;
		font-size: 0.95rem;
	}

	.search-tips kbd {
		padding: 0.25rem 0.5rem;
		background: #f5f5f5;
		border: 1px solid #ddd;
		border-radius: 4px;
		font-family: monospace;
		font-size: 0.9em;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
		}
		to {
			opacity: 1;
		}
	}

	@keyframes slideUp {
		from {
			opacity: 0;
			transform: translateY(20px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	/* å“åº”å¼ */
	@media (max-width: 720px) {
		.search-modal {
			padding-top: 5vh;
		}

		.search-modal-content {
			width: 95%;
			max-height: 85vh;
		}

		.search-modal-header {
			padding: 1rem;
		}

		.search-results {
			padding: 0.75rem 1rem 1rem;
		}

		#modal-search-input {
			font-size: 1rem;
		}
	}
</style>

<!-- å…¨å±€æ ·å¼ç”¨äºåŠ¨æ€æ’å…¥çš„å…ƒç´  -->
<style is:global>
	.search-modal .result-item {
		position: relative;
		padding: 1.25rem;
		margin-bottom: 1rem;
		background: white;
		border: 2px solid transparent;
		border-color: rgba(var(--accent), 0.2);
		border-radius: 12px;
		transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
		overflow: hidden;
	}

	.search-modal .result-item::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		width: 4px;
		height: 0;
		background: linear-gradient(180deg, rgb(var(--accent)) 0%, rgba(var(--accent), 0.6) 100%);
		transition: height 0.3s ease;
	}

	.search-modal .result-item:hover {
		border-color: rgba(var(--accent), 0.4);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
		transform: translateX(4px);
	}

	.search-modal .result-item:hover::before {
		height: 100%;
	}

	.search-modal .result-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		gap: 1rem;
	}

	.search-modal .result-title {
		margin: 0;
		font-size: 1.1em;
		font-weight: 600;
		flex: 1;
		line-height: 1.4;
	}

	.search-modal .result-title a {
		text-decoration: none;
		transition: all 0.2s ease;
		background: linear-gradient(to right, rgb(var(--accent)) 0%, rgb(var(--accent)) 100%);
		background-size: 0 2px;
		background-repeat: no-repeat;
		background-position: left bottom;
		padding-bottom: 2px;
	}

	.search-modal .result-title a:hover {
		color: rgb(var(--accent));
		background-size: 100% 2px;
	}

	.search-modal .result-date {
		display: inline-flex;
		align-items: center;
		padding: 0.3em 0.7em;
		color: #666;
		font-size: 0.8em;
		border-radius: 6px;
		white-space: nowrap;
		font-weight: 500;
		background: #f5f5f5;
	}

	.search-modal .result-description {
		margin: 0.75rem 0 0;
		color: rgb(var(--gray));
		line-height: 1.6;
		font-size: 0.9em;
	}

	.search-modal .result-tags {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		margin-top: 0.75rem;
	}

	.search-modal .result-tags .tag {
		display: inline-flex;
		align-items: center;
		padding: 0.3em 0.8em;
		background: rgba(var(--accent), 0.1);
		color: rgb(var(--accent));
		border-radius: 16px;
		font-size: 0.8em;
		font-weight: 500;
		transition: all 0.2s ease;
	}

	.search-modal .result-tags .tag:hover {
		background: rgba(var(--accent), 0.2);
	}

	.search-modal .no-results {
		text-align: center;
		padding: 4rem 2rem;
		border-radius: 12px;
		font-size: 1.1em;
		color: rgb(var(--gray));
	}

	/* å…³é”®è¯é«˜äº® */
	.search-modal mark {
		background: linear-gradient(135deg, rgba(var(--accent), 0.25) 0%, rgba(var(--accent), 0.15) 100%);
		color: rgb(var(--accent));
		padding: 0.15em 0.3em;
		border-radius: 4px;
		font-weight: 700;
		box-shadow: 0 2px 4px rgba(var(--accent), 0.1);
	}

	/* åŠ è½½åŠ¨ç”» */
	@keyframes fadeInResult {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.search-modal .result-item {
		animation: fadeInResult 0.3s ease-out;
	}

	.search-modal .result-item:nth-child(1) { animation-delay: 0.05s; }
	.search-modal .result-item:nth-child(2) { animation-delay: 0.1s; }
	.search-modal .result-item:nth-child(3) { animation-delay: 0.15s; }
	.search-modal .result-item:nth-child(4) { animation-delay: 0.2s; }
	.search-modal .result-item:nth-child(5) { animation-delay: 0.25s; }

	/* å“åº”å¼ */
	@media (max-width: 720px) {
		.search-modal .result-header {
			flex-direction: column;
			gap: 0.6rem;
		}

		.search-modal .result-date {
			align-self: flex-start;
		}

		.search-modal .result-title {
			font-size: 1em;
		}

		.search-modal .result-item {
			padding: 1rem;
		}
	}
</style>
